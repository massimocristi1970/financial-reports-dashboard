<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Reports Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* keep your original CSS here */
  </style>
</head>
<body>
  <div class="app-container">
    <!-- your sidebar & main content unchanged -->
  </div>

  <script>
    const FinancialDashboard = {
      data: {
        'lending-volume': [],
        'arrears': [],
        'liquidations': [],
        'call-center': [],
        'complaints': []
      },
      charts: {}, // store chart.js instances

      // ... keep your configs & init functions ...

      renderReport(reportType) {
        const reportContent = document.querySelector(`[data-report="${reportType}"]`);
        const data = this.data[reportType];
        const config = this.reportConfigs[reportType];

        if (!reportContent || !data.length) {
          reportContent.innerHTML = `
            <div class="chart-card" style="text-align:center;padding:60px;">
              <i class="fas fa-database fa-3x" style="color:#cbd5e1;margin-bottom:20px;"></i>
              <h3 style="color:#64748b;margin-bottom:10px;">No Data Available</h3>
              <p style="color:#9ca3af;">Upload a CSV file to view ${config.title} analytics</p>
              <button class="btn btn-primary" onclick="FinancialDashboard.showPage('data-management')">
                <i class="fas fa-upload"></i> Upload Data
              </button>
            </div>
          `;
          return;
        }

        const kpiData = this.calculateKPIs(data, reportType);
        const kpiHTML = config.kpis.map(kpi => {
          const value = kpiData[kpi.key];
          const formatted = this.formatValue(value, kpi.format);
          const colorClass = this.getKPIColorClass(kpi.key);
          return `
            <div class="kpi-card ${colorClass}">
              <div class="kpi-title">${kpi.label}</div>
              <div class="kpi-value">${formatted}</div>
              <div class="kpi-change">Based on ${data.length} records</div>
            </div>
          `;
        }).join('');

        const tableHTML = this.renderDataTable(data, reportType);

        reportContent.innerHTML = `
          <div class="kpi-grid">${kpiHTML}</div>
          <div class="dashboard-grid">
            <div class="chart-card">
              <h3 class="chart-title">Data Visualization</h3>
              <canvas id="${reportType}-chart" height="200"></canvas>
            </div>
            <div class="chart-card">
              <h3 class="chart-title">Key Insights</h3>
              ${this.renderInsights(data, reportType)}
            </div>
          </div>
          <div class="data-table">
            <div class="table-header">
              <h3 class="chart-title">Data Records (${data.length} total)</h3>
              <button class="btn btn-outline" onclick="FinancialDashboard.exportData('${reportType}')">
                <i class="fas fa-download"></i> Export CSV
              </button>
            </div>
            ${tableHTML}
          </div>
        `;

        this.renderChart(data, reportType);
      },

      renderChart(data, reportType) {
        const ctx = document.getElementById(`${reportType}-chart`)?.getContext('2d');
        if (!ctx) return;

        if (this.charts[reportType]) this.charts[reportType].destroy();

        let labels = [];
        let values = [];

        switch (reportType) {
          case 'lending-volume':
          case 'arrears':
            labels = [...new Set(data.map(r => r.stage || 'Unknown'))];
            values = labels.map(label => data.filter(r => (r.stage || 'Unknown') === label).length);
            break;
          case 'liquidations':
            labels = data.map(r => r.funded_month || 'Unknown');
            values = data.map(r => parseFloat(r.funded) || 0);
            break;
          case 'call-center':
            labels = [...new Set(data.map(r => r.disposition || 'Unknown'))];
            values = labels.map(label => data.filter(r => (r.disposition || 'Unknown') === label).length);
            break;
          case 'complaints':
            labels = [...new Set(data.map(r => r.category || 'Unknown'))];
            values = labels.map(label => data.filter(r => (r.category || 'Unknown') === label).length);
            break;
        }

        this.charts[reportType] = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: `${this.reportConfigs[reportType].title}`,
              data: values,
              backgroundColor: 'rgba(59,130,246,0.6)',
              borderColor: 'rgba(59,130,246,1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });
      },

      renderInsights(data, reportType) {
        const total = data.length;
        let insights = [`<li>Total records: <strong>${total}</strong></li>`];

        switch (reportType) {
          case 'lending-volume':
            const funded = data.filter(r => r.stage?.toLowerCase().includes('fund')).length;
            insights.push(`<li>Funded applications: <strong>${funded}</strong></li>`);
            break;
          case 'arrears':
            const arrears = data.filter(r => r.stage && !['Funded','Repaid','Closed'].includes(r.stage)).length;
            insights.push(`<li>Accounts in arrears: <strong>${arrears}</strong></li>`);
            break;
          case 'liquidations':
            const avgRate = (data.reduce((s,r)=>s+(parseFloat(r.actual_liquidation_rate)||0),0)/data.length).toFixed(2);
            insights.push(`<li>Average liquidation rate: <strong>${avgRate}%</strong></li>`);
            break;
          case 'call-center':
            const avgTalk = (data.reduce((s,r)=>s+(parseFloat(r.talk_time)||0),0)/data.length).toFixed(1);
            insights.push(`<li>Average talk time: <strong>${avgTalk} mins</strong></li>`);
            break;
          case 'complaints':
            const unresolved = data.filter(r => !r.resolved_date).length;
            insights.push(`<li>Open complaints: <strong>${unresolved}</strong></li>`);
            break;
        }

        return `<ul style="line-height:1.8;color:#374151;">${insights.join('')}</ul>`;
      },

      // keep the rest of your functions (calculateKPIs, parseCSV, etc.)
    };

    document.addEventListener('DOMContentLoaded', () => FinancialDashboard.init());
  </script>
</body>
</html>
