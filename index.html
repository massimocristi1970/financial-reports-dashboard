<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Financial Reports Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f8fafc; }
    .app-container { display:flex; min-height:100vh; }
    .sidebar { width:260px; background:#fff; border-right:1px solid #ddd; }
    .sidebar-header { padding:16px; font-weight:700; border-bottom:1px solid #eee; }
    .nav-link { display:block; padding:10px 16px; cursor:pointer; color:#333; }
    .nav-link:hover { background:#f1f5f9; }
    .nav-link.active { background:#eef6ff; border-left:3px solid #3b82f6; color:#1d4ed8; }
    .main-content { flex:1; padding:20px; }
    .hidden { display:none; }
    .panel { background:#fff; border:1px solid #ddd; border-radius:8px; padding:16px; margin-bottom:16px; }
    .kpi-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
    .kpi { background:#f8fafc; border:1px solid #e5e7eb; border-radius:8px; padding:12px; }
    .kpi .label { font-size:12px; color:#555; }
    .kpi .value { font-size:20px; font-weight:700; }
    .filters { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
    .filters label { font-size:12px; font-weight:600; display:block; margin-bottom:4px; }
    .filters select { padding:6px; border-radius:6px; border:1px solid #ccc; }
    .charts-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:16px; }
    .data-table { overflow:auto; max-height:400px; border:1px solid #ddd; border-radius:8px; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px 12px; border-bottom:1px solid #eee; }
    th { background:#f1f5f9; position:sticky; top:0; }
  </style>
</head>
<body>
<div class="app-container">
  <aside class="sidebar">
    <div class="sidebar-header"><i class="fas fa-chart-line"></i> Financial Reports</div>
    <nav>
      <div class="nav-link active" onclick="showPage(event,'overview')">Overview</div>
      <div class="nav-link" onclick="showPage(event,'data-management')">Data Management</div>
      <div class="nav-link" onclick="showPage(event,'lending-volume')">Lending Volume</div>
      <div class="nav-link" onclick="showPage(event,'arrears')">Arrears</div>
      <div class="nav-link" onclick="showPage(event,'liquidations')">Liquidations</div>
      <div class="nav-link" onclick="showPage(event,'complaints')">Complaints</div>
      <div class="nav-link" onclick="showPage(event,'financial-crime')">Financial Crime</div>
    </nav>
  </aside>
  <main class="main-content">
    <section id="overview-page">
      <div class="panel"><h2>Welcome</h2><div id="overview-summary"></div></div>
    </section>
    <section id="data-management-page" class="hidden">
      <div class="panel"><h2>Data Management</h2>
        <p>Data is auto-loaded from shared-data/*.csv</p>
      </div>
    </section>
    <section id="lending-volume-page" class="hidden"><div class="panel"><h2>Lending Volume</h2><div id="lending-volume-filters"></div><div id="lending-volume-content"></div></div></section>
    <section id="arrears-page" class="hidden"><div class="panel"><h2>Arrears</h2><div id="arrears-filters"></div><div id="arrears-content"></div></div></section>
    <section id="liquidations-page" class="hidden"><div class="panel"><h2>Liquidations</h2><div id="liquidations-filters"></div><div id="liquidations-content"></div></div></section>
    <section id="complaints-page" class="hidden"><div class="panel"><h2>Complaints</h2><div id="complaints-filters"></div><div id="complaints-content"></div></div></section>
    <section id="financial-crime-page" class="hidden"><div class="panel"><h2>Financial Crime</h2><div id="financial-crime-filters"></div><div id="financial-crime-content"></div></div></section>
  </main>
</div>

<script>
// ---------- Helpers ----------
function toDate(v){
  if (!v) return null;
  const d=new Date(v);
  if (!isNaN(d)) return d;
  const m=String(v).match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if (m) return new Date(+m[3],+m[2]-1,+m[1]);
  return null;
}
function uniqueSorted(arr){return Array.from(new Set(arr)).filter(Boolean).sort((a,b)=>(''+a).localeCompare((''+b),undefined,{numeric:true}));}
function sumField(data,f){return data.reduce((a,r)=>a+(parseFloat(r[f])||0),0);}
function avgField(data,f){const nums=data.map(r=>parseFloat(r[f])||0).filter(v=>v>0);return nums.length?nums.reduce((a,b)=>a+b,0)/nums.length:0;}
function fmtMoney(n){return (n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});}

// ---------- CSV ----------
function detectDelimiter(line){let c=(d)=>{let cnt=0,inQ=false;for(let i=0;i<line.length;i++){if(line[i]==='"')inQ=!inQ;else if(!inQ&&line[i]===d)cnt++;}return cnt;};return c('\t')>c(',')?'\t':',';}
function splitRow(row,delim){const out=[];let cur='',inQ=false;for(let i=0;i<row.length;i++){const ch=row[i];if(ch==='"'){if(inQ&&row[i+1]==='"'){cur+='"';i++;}else inQ=!inQ;}else if(ch===delim&&!inQ){out.push(cur);cur='';}else cur+=ch;}out.push(cur);return out;}
function parseCSV(text){
  const lines=String(text||'').replace(/^\uFEFF/,'').split(/\r?\n/).filter(l=>l.trim());
  if(!lines.length) return [];
  const delim=detectDelimiter(lines[0]);
  const headers=splitRow(lines[0],delim).map(h=>h.trim().toLowerCase().replace(/\s+/g,'_'));
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const parts=splitRow(lines[i],delim);
    if(!parts.length) continue;
    const rec={};
    headers.forEach((h,j)=>{
      let v=(parts[j]||'').trim();
      if(v.match(/[£€$,]/)){v=v.replace(/[£€$,]/g,'');if(!isNaN(parseFloat(v)))v=parseFloat(v);}
      else if(!isNaN(parseFloat(v))) v=parseFloat(v);
      rec[h]=v;
    });
    if(Object.values(rec).some(v=>v!=='')) rows.push(rec);
  }
  return rows;
}

// ---------- Data + Config ----------
const reportData={ 'lending-volume':[], 'arrears':[], 'liquidations':[], 'complaints':[], 'financial-crime':[] };
const reportConfigs={
  'lending-volume':{dateField:'fundeddate',amountField:'issuedamount',filterFields:['tiername','stage'],
    kpis:d=>[{label:'Total Issued',value:'£'+fmtMoney(sumField(d,'issuedamount'))},{label:'Average Issued',value:'£'+fmtMoney(avgField(d,'issuedamount'))}]},
  'arrears':{dateField:'stagedate',amountField:'totaldue',filterFields:['tiername','stage'],
    kpis:d=>[{label:'Total Due',value:'£'+fmtMoney(sumField(d,'totaldue'))},{label:'Average Due',value:'£'+fmtMoney(avgField(d,'totaldue'))}]},
  'liquidations':{dateField:'stagedate',amountField:'totaldue',filterFields:['tiername','stage'],
    kpis:d=>[{label:'Total Paid',value:'£'+fmtMoney(sumField(d,'payment'))},{label:'Total Issued',value:'£'+fmtMoney(sumField(d,'issuedamount'))},{label:'Recovery %',value:((sumField(d,'payment')/sumField(d,'issuedamount'))*100).toFixed(1)+'%'}]},
  'complaints':{dateField:'receiveddate',filterFields:['category','decision'],
    kpis:d=>[{label:'Total Complaints',value:d.length.toLocaleString()}]},
  'financial-crime':{dateField:'date_reported',amountField:'principal',filterFields:['loan_source','appstatus','decision'],
    kpis:d=>[{label:'Total Principal',value:'£'+fmtMoney(sumField(d,'principal'))},{label:'Average Principal',value:'£'+fmtMoney(avgField(d,'principal'))}]}
};

// ---------- Navigation ----------
function showPage(e,id){
  document.querySelectorAll('[id$="-page"]').forEach(p=>p.classList.add('hidden'));
  document.getElementById(id+'-page').classList.remove('hidden');
  if(reportConfigs[id]){buildFiltersUI(id);renderReport(id);}
}

// ---------- Filters ----------
function buildFiltersUI(type){
  const container=document.getElementById(`${type}-filters`);
  const cfg=reportConfigs[type];const data=reportData[type]||[];
  container.innerHTML='';if(!data.length)return;
  const wrap=document.createElement('div');wrap.className='filters';
  const years=uniqueSorted(data.map(r=>{const d=toDate(r[cfg.dateField]);return d?d.getFullYear():null;}).filter(Boolean));
  if(years.length){const sel=document.createElement('select');sel.id=`${type}-year`;sel.onchange=()=>renderReport(type);sel.innerHTML='<option value="">All Years</option>'+years.map(y=>`<option>${y}</option>`).join('');wrap.appendChild(sel);}
  container.appendChild(wrap);
}

// ---------- Render ----------
function renderReport(type){
  const content=document.getElementById(`${type}-content`);const cfg=reportConfigs[type];const data=reportData[type]||[];
  if(!data.length){content.innerHTML='<div class="panel">No data uploaded.</div>';return;}
  const kpiItems=cfg.kpis(data);
  const kpiHtml='<div class="kpi-grid">'+kpiItems.map(k=>`<div class="kpi"><div class="label">${k.label}</div><div class="value">${k.value}</div></div>`).join('')+'</div>';
  const headers=Object.keys(data[0]);const table='<div class="data-table"><table><thead><tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr></thead><tbody>'+data.slice(0,50).map(r=>'<tr>'+headers.map(h=>`<td>${r[h]||''}</td>`).join('')+'</tr>').join('')+'</tbody></table></div>';
  content.innerHTML=kpiHtml+table;
}

// ---------- Load Shared Data ----------
async function loadSharedData(){
  const files={
    'lending-volume':'shared-data/lending_volume.csv',
    'arrears':'shared-data/lending_volume.csv',
    'liquidations':'shared-data/lending_volume.csv',
    'complaints':'shared-data/complaints.csv',
    'financial-crime':'shared-data/financial_crime.csv'
  };
  for(const [type,path] of Object.entries(files)){
    try{
      const res=await fetch(path);const text=await res.text();reportData[type]=parseCSV(text);
      console.log(`Loaded ${reportData[type].length} for ${type}`);buildFiltersUI(type);
    }catch(err){console.error('Error loading',type,err);}
  }
  updateOverviewSummary();
}
function updateOverviewSummary(){
  const c=document.getElementById("overview-summary");c.innerHTML='';
  Object.keys(reportConfigs).forEach(t=>{
    const d=reportData[t]||[];
    if(!d.length){c.innerHTML+=`<div class="kpi"><div class="label">${t}</div><div class="value">No data</div></div>`;}
    else{const kpis=reportConfigs[t].kpis(d);const top=kpis[0];c.innerHTML+=`<div class="kpi"><div class="label">${t}</div><div class="value">${top.value}</div></div>`;}
  });
}

// ---------- Init ----------
document.addEventListener('DOMContentLoaded',()=>{loadSharedData();});
</script>
</body>
</html>
