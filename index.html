<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Financial Reports Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --blue:#3b82f6;
      --green:#10b981;
      --orange:#f59e0b;
      --red:#ef4444;
      --slate:#334155;
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e5e7eb;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#0f172a}
    .app{display:flex;min-height:100vh}
    .sidebar{width:240px;background:#fff;border-right:1px solid var(--border)}
    .sidebar-header{padding:16px 18px;font-weight:800;border-bottom:1px solid var(--border)}
    .nav-link{display:block;padding:12px 16px;color:var(--slate);text-decoration:none;cursor:pointer}
    .nav-link:hover{background:#f1f5f9}
    .nav-link.active{background:#eef6ff;border-left:3px solid var(--blue);color:#1d4ed8}
    main{flex:1;padding:24px}
    .hidden{display:none}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:18px}
    .filters{display:flex;gap:16px;row-gap:10px;flex-wrap:wrap;align-items:flex-end}
    .filters label{display:block;font-size:12px;font-weight:700;margin-bottom:6px;color:#475569}
    .filters select{min-width:150px;padding:6px;border-radius:8px;border:1px solid #cbd5e1}
    .filters select[multiple]{height:110px}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--border);border-radius:8px;cursor:pointer;background:#fff}
    .btn-primary{border-color:transparent;background:var(--blue);color:#fff}
    .btn-outline{background:#fff}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .kpi{background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:12px}
    .kpi .label{font-size:12px;color:#64748b}
    .kpi .value{font-size:20px;font-weight:800;margin-top:6px}
    .charts{display:grid;grid-template-columns:1fr;gap:16px}
    .chart-card h3{margin:0 0 8px;font-size:14px;color:#334155}
    .table-wrap{max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
    th{background:#f8fafc;position:sticky;top:0;z-index:1}
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="sidebar-header"><i class="fas fa-chart-line"></i> Financial Reports</div>
    <a class="nav-link active" data-page="overview">Overview</a>
    <a class="nav-link" data-page="lending-volume">Lending Volume</a>
    <a class="nav-link" data-page="arrears">Arrears</a>
    <a class="nav-link" data-page="liquidations">Liquidations</a>
    <a class="nav-link" data-page="complaints">Complaints</a>
    <a class="nav-link" data-page="financial-crime">Financial Crime</a>
  </aside>

  <main>
    <!-- Overview -->
    <section id="overview-page" class="page">
      <div class="panel"><h2>Welcome</h2><p>Data auto-loaded from <code>/shared-data/</code> CSVs in this repo.</p></div>
    </section>

    <!-- Lending -->
    <section id="lending-volume-page" class="page hidden">
      <div class="panel">
        <h2>Lending Volume</h2>
        <div id="lending-volume-filters" class="filters"></div>
        <button class="btn btn-outline" id="lending-volume-reset"><i class="fas fa-eraser"></i> Reset Filters</button>
      </div>
      <div id="lending-volume-content"></div>
    </section>

    <!-- Arrears -->
    <section id="arrears-page" class="page hidden">
      <div class="panel">
        <h2>Arrears</h2>
        <div id="arrears-filters" class="filters"></div>
        <button class="btn btn-outline" id="arrears-reset"><i class="fas fa-eraser"></i> Reset Filters</button>
      </div>
      <div id="arrears-content"></div>
    </section>

    <!-- Liquidations -->
    <section id="liquidations-page" class="page hidden">
      <div class="panel">
        <h2>Liquidations</h2>
        <div id="liquidations-filters" class="filters"></div>
        <button class="btn btn-outline" id="liquidations-reset"><i class="fas fa-eraser"></i> Reset Filters</button>
      </div>
      <div id="liquidations-content"></div>
    </section>

    <!-- Keep generic for these two (unchanged for now) -->
    <section id="complaints-page" class="page hidden">
      <div class="panel"><h2>Complaints</h2><div id="complaints-content"></div></div>
    </section>
    <section id="financial-crime-page" class="page hidden">
      <div class="panel"><h2>Financial Crime</h2><div id="financial-crime-content"></div></div>
    </section>
  </main>
</div>

<script>
/* -------------------- Data sources -------------------- */
const dataSources = {
  "lending-volume":"shared-data/lending_volume.csv",
  "arrears":"shared-data/lending_volume.csv",
  "liquidations":"shared-data/lending_volume.csv",
  "complaints":"shared-data/complaints.csv",
  "financial-crime":"shared-data/financial_crime.csv"
};

const dateField = {
  "lending-volume":"fundeddate",
  "arrears":"stagedate",
  "liquidations":"stagedate",
  "complaints":"receiveddate",
  "financial-crime":"datereported"
};

const reportData = {};   // raw normalised data per report
const charts = {};       // chart instances per canvas id

/* -------------------- Helpers -------------------- */
function normalizeHeader(h){
  return String(h||'')
    .trim()
    .toLowerCase()
    .replace(/\s+/g,'');   // strip spaces entirely
}
function cleanNumber(v){
  if(v===null||v===undefined) return 0;
  const n = parseFloat(String(v).replace(/[£€$,]/g,'').trim());
  return Number.isFinite(n) ? n : 0;
}
function toDateSafe(v){
  if (v == null) return null;
  if (v instanceof Date) return isNaN(v) ? null : v;

  let s = String(v).trim();
  if (!s) return null;

  // Excel serial date (days since 1899-12-30). Typical modern range ~ 30k–60k
  if (/^\d{4,6}$/.test(s)) {
    const n = Number(s);
    if (n >= 25569 && n <= 70000) { // 1970-01-01..mid-century-ish
      const baseUTC = Date.UTC(1899, 11, 30);
      return new Date(baseUTC + n * 86400000);
    }
  }

  // ISO-like YYYY-MM-DD or YYYY/MM/DD
  let m = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
  if (m) return new Date(+m[1], +m[2]-1, +m[3]);

  // D/M/Y or M/D/Y -> infer by which side exceeds 12; fallback to D/M/Y
  m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (m) {
    const a = +m[1], b = +m[2], y = +m[3] < 100 ? 2000 + (+m[3]) : +m[3];
    if (a > 12 && b <= 12) return new Date(y, b-1, a); // D/M/Y
    if (b > 12 && a <= 12) return new Date(y, a-1, b); // M/D/Y
    return new Date(y, b-1, a);                         // default D/M/Y
  }

  const d = new Date(s);
  return isNaN(d) ? null : d;
}
function fmtMoney(n){ return "£"+(cleanNumber(n)).toLocaleString(undefined,{maximumFractionDigits:2}); }
function sum(rows, key){ return rows.reduce((a,r)=>a + cleanNumber(r[key]), 0); }
function avg(rows, key){ const vals=rows.map(r=>cleanNumber(r[key])).filter(v=>v>0); return vals.length? vals.reduce((a,b)=>a+b,0)/vals.length : 0; }

/* -------------------- CSV Parser (robust, consistent headers) -------------------- */
function parseCSV(text){
  const lines = String(text||'').replace(/^\uFEFF/,'').split(/\r?\n/);
  // remove trailing blank lines but keep empty fields
  const rows = lines.filter((l,i)=> i===0 || l.trim() !== '');
  if(!rows.length) return [];
  // delimiter detection with quotes
  const head = rows[0];
  const count = (s)=>{let c=0,inQ=false;for(let i=0;i<head.length;i++){const ch=head[i];if(ch==='"') inQ=!inQ; else if(!inQ && ch===s) c++;}return c;};
  const delim = (count('\t')>count(',') && count('\t')>count(';')) ? '\t' : (count(';')>count(',')?';':',');

  const splitRow=(row)=>{const out=[];let cur='',inQ=false;for(let i=0;i<row.length;i++){const ch=row[i];if(ch==='"'){if(inQ && row[i+1]==='"'){cur+='"';i++;}else inQ=!inQ;}else if(ch===delim && !inQ){out.push(cur);cur='';}else cur+=ch;}out.push(cur);return out;};

  const headers = splitRow(rows[0]).map(normalizeHeader);
  const data = [];
  for(let i=1;i<rows.length;i++){
    const parts = splitRow(rows[i]);
    if(!parts.length) continue;
    const rec={};
    headers.forEach((h,idx)=> rec[h]=(parts[idx]??'').trim().replace(/\uFFFD/g,'')); // strip �
    // only push if something non-empty
    if(Object.values(rec).some(v=>String(v).trim()!=='')) data.push(rec);
  }
  return data;
}

/* -------------------- Filters UI -------------------- */
function buildFilters(report){
  const container = document.getElementById(`${report}-filters`);
  const rows = reportData[report] || [];
  container.innerHTML = '';

  const df = dateField[report];
  const years = new Set(), months = new Set();
  const tiers = new Set(), stages = new Set();

  rows.forEach(r=>{
    const d = toDateSafe(r[df]);
    if(d){ years.add(d.getFullYear()); months.add(d.getMonth()+1); }
    if(r.tiername) tiers.add(r.tiername);
    if(r.stage) stages.add(r.stage);
  });

  const yList = Array.from(years)
    .filter(y => y >= 1990 && y <= 2100) // only keep real years
    .sort((a,b)=>a-b);
  const mList = Array.from(months).sort((a,b)=>a-b);
  const tList = Array.from(tiers).sort((a,b)=>(''+a).localeCompare(''+b,undefined,{numeric:true}));
  const sList = Array.from(stages).sort((a,b)=>(''+a).localeCompare(''+b,undefined,{numeric:true}));

  const wrap = document.createElement('div');
  wrap.className = 'filters';

  const mkMulti = (id,label,values,formatter=(x)=>x)=>{
    const box = document.createElement('div');
    box.innerHTML = `<label for="${id}">${label}</label>
      <select id="${id}" multiple>
        ${values.map(v=>`<option value="${v}">${formatter(v)}</option>`).join('')}
      </select>`;
    wrap.appendChild(box);
    return box.querySelector('select');
  };

  const ySel = mkMulti(`${report}-year`,'Year',yList,String);
  const mSel = mkMulti(`${report}-month`,'Month',mList,v=>String(v).padStart(2,'0'));
  const tSel = mkMulti(`${report}-tiername`,'Tier',tList,String);
  const sSel = mkMulti(`${report}-stage`,'Stage',sList,String);

  // Ensure nothing is preselected
  [ySel, mSel, tSel, sSel].forEach(sel=>{
    Array.from(sel.options).forEach(o=>o.selected = false);
  });

  [ySel,mSel,tSel,sSel].forEach(sel=> sel.addEventListener('change',()=> {
    if(report==='lending-volume') renderLendingReport();
    else if(report==='arrears') renderArrearsReport();
    else if(report==='liquidations') renderLiquidationsReport();
  }));

  // Reset button
  const resetBtn = document.createElement('button');
  resetBtn.textContent = "Reset Filters";
  resetBtn.className = "btn btn-outline";
  resetBtn.onclick = ()=>{
    [ySel,mSel,tSel,sSel].forEach(sel=> Array.from(sel.options).forEach(o=>o.selected=false));
    if(report==='lending-volume') renderLendingReport();
    else if(report==='arrears') renderArrearsReport();
    else if(report==='liquidations') renderLiquidationsReport();
  };

  container.appendChild(wrap);
  container.appendChild(resetBtn);
}

function getFiltered(report, dfKey) {
  const rows = reportData[report] || [];

  const ySel = Array.from(document.getElementById(report+'-year')?.selectedOptions||[]).map(o=>o.value);
  const mSel = Array.from(document.getElementById(report+'-month')?.selectedOptions||[]).map(o=>o.value);
  const tSel = Array.from(document.getElementById(report+'-tiername')?.selectedOptions||[]).map(o=>o.value);
  const sSel = Array.from(document.getElementById(report+'-stage')?.selectedOptions||[]).map(o=>o.value);

  return rows.filter(r=>{
    const d = toDateSafe(r[dfKey]);
    if (ySel.length && (!d || !ySel.includes(String(d.getFullYear())))) return false;
    if (mSel.length && (!d || !mSel.includes(String(d.getMonth()+1).padStart(2,'0')))) return false;

    if (tSel.length && !tSel.includes(r.tiername||'')) return false;
    if (sSel.length && !sSel.includes(r.stage||'')) return false;
    return true;
  });
}

/* -------------------- Chart helpers -------------------- */
function destroyChart(id){ if(charts[id]){ charts[id].destroy(); delete charts[id]; } }

function lineByMonth(canvasId, rows, valField, dfLabel, label, color){
  const agg={};
  rows.forEach(r=>{
    const d = toDateSafe(r[dfLabel]); if(!d) return;
    const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    agg[k]=(agg[k]||0)+cleanNumber(r[valField]);
  });
  const labels = Object.keys(agg).sort();
  const values = labels.map(k=>agg[k]);

  destroyChart(canvasId);
  charts[canvasId] = new Chart(document.getElementById(canvasId), {
    type:'line',
    data:{ labels, datasets:[{ label, data:values, borderWidth:2, borderColor:color, backgroundColor:color, tension:.2, fill:false }] },
    options:{ responsive:true, plugins:{legend:{display:true}}, scales:{ y:{ beginAtZero:true } } }
  });
}

function groupedLineByMonth(canvasId, rows, fA, fB, dfLabel, labelA, labelB, colorA, colorB){
  const aggA={}, aggB={};
  rows.forEach(r=>{
    const d = toDateSafe(r[dfLabel]); if(!d) return;
    const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    aggA[k]=(aggA[k]||0)+cleanNumber(r[fA]);
    aggB[k]=(aggB[k]||0)+cleanNumber(r[fB]);
  });
  const labels = Array.from(new Set([...Object.keys(aggA), ...Object.keys(aggB)])).sort();
  const vA = labels.map(k=>aggA[k]||0);
  const vB = labels.map(k=>aggB[k]||0);

  destroyChart(canvasId);
  charts[canvasId] = new Chart(document.getElementById(canvasId),{
    type:'line',
    data:{ labels, datasets:[
      {label:labelA, data:vA, borderWidth:2, borderColor:colorA, backgroundColor:colorA, tension:.2, fill:false},
      {label:labelB, data:vB, borderWidth:2, borderColor:colorB, backgroundColor:colorB, tension:.2, fill:false}
    ]},
    options:{ responsive:true, plugins:{legend:{display:true}}, scales:{ y:{ beginAtZero:true } } }
  });
}

function groupedBars(canvasId, rows, fieldA, fieldB, catField, labelA, labelB, colA, colB){
  const sumsA={}, sumsB={};
  rows.forEach(r=>{
    const k=r[catField]||'Unknown';
    sumsA[k]=(sumsA[k]||0)+cleanNumber(r[fieldA]);
    sumsB[k]=(sumsB[k]||0)+cleanNumber(r[fieldB]);
  });
  const labels = Array.from(new Set([...Object.keys(sumsA), ...Object.keys(sumsB)])).sort();
  const vA = labels.map(l=>sumsA[l]||0);
  const vB = labels.map(l=>sumsB[l]||0);

  destroyChart(canvasId);
  charts[canvasId]=new Chart(document.getElementById(canvasId),{
    type:'bar',
    data:{ labels, datasets:[
      {label:labelA, data:vA, backgroundColor:colA},
      {label:labelB, data:vB, backgroundColor:colB}
    ]},
    options:{ responsive:true, plugins:{legend:{display:true}}, scales:{ y:{ beginAtZero:true } } }
  });
}

function barGroupSum(canvasId, rows, sumField, catField, label, color){
  const sums={};
  rows.forEach(r=>{
    const k=r[catField]||'Unknown';
    sums[k]=(sums[k]||0)+cleanNumber(r[sumField]);
  });
  const labels=Object.keys(sums).sort();
  const values=labels.map(k=>sums[k]);

  destroyChart(canvasId);
  charts[canvasId]=new Chart(document.getElementById(canvasId),{
    type:'bar',
    data:{ labels, datasets:[{label, data:values, backgroundColor:color}] },
    options:{ responsive:true, plugins:{legend:{display:true}}, scales:{ y:{ beginAtZero:true } } }
  });
}

/* -------------------- Tables -------------------- */
function renderTable(rows, maxRows=100){
  if(!rows.length) return '';
  const headers = Object.keys(rows[0]);
  const head = `<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
  const body = `<tbody>${rows.slice(0,maxRows).map(r=>`<tr>${headers.map(h=>`<td>${r[h]??''}</td>`).join('')}</tr>`).join('')}</tbody>`;
  return `<div class="table-wrap"><table>${head}${body}</table></div>`;
}

/* -------------------- Dedicated renderers -------------------- */
function renderLendingReport(data=null){
  const report='lending-volume';
  const target=document.getElementById(`${report}-content`);
  const rows = data || getFiltered(report, dateField[report]);
  if(!rows.length){ target.innerHTML = `<div class="panel">No data for current filters.</div>`; return; }

  const totalIssued = sum(rows,'issuedamount');
  const avgIssued = avg(rows,'issuedamount');
  const fundedCount = rows.reduce((a,r)=> a + (cleanNumber(r.count) || 1), 0);

  const kpiHTML = `<div class="panel"><div class="kpis">
    <div class="kpi"><div class="label">Total Issued</div><div class="value">${fmtMoney(totalIssued)}</div></div>
    <div class="kpi"><div class="label">Average Issued</div><div class="value">${fmtMoney(avgIssued)}</div></div>
    <div class="kpi"><div class="label">Funded Count</div><div class="value">${fundedCount.toLocaleString()}</div></div>
  </div></div>`;

  const lineId='lv-line', barId='lv-bar';
  const chartsHTML = `<div class="charts">
    <div class="chart-card"><h3>Issued Amount by Month</h3><canvas id="${lineId}"></canvas></div>
    <div class="chart-card"><h3>Issued Amount by Tier</h3><canvas id="${barId}"></canvas></div>
  </div>`;

  target.innerHTML = kpiHTML + chartsHTML + `<div class="panel">${renderTable(rows)}</div>`;

  lineByMonth(lineId, rows, 'issuedamount', dateField[report], 'Issued Amount', '#3b82f6');
  barGroupSum(barId, rows, 'issuedamount', 'tiername', 'Issued', '#3b82f6');
}

function renderArrearsReport(data=null){
  const report='arrears';
  const target=document.getElementById(`${report}-content`);
  const rows = data || getFiltered(report, dateField[report]);
  if(!rows.length){ target.innerHTML = `<div class="panel">No data for current filters.</div>`; return; }

  const totalIssued = sum(rows,'issuedamount');
  const totalDue = sum(rows,'totaldue');
  const arrearsRate = totalIssued ? (totalDue/totalIssued*100) : 0;

  const kpiHTML = `<div class="panel"><div class="kpis">
    <div class="kpi"><div class="label">Total Issued Amount</div><div class="value">${fmtMoney(totalIssued)}</div></div>
    <div class="kpi"><div class="label">Total Due</div><div class="value">${fmtMoney(totalDue)}</div></div>
    <div class="kpi"><div class="label">Arrears Rate</div><div class="value">${arrearsRate.toFixed(1)}%</div></div>
  </div></div>`;

  const lineId='arr-line', barId='arr-bar';
  const chartsHTML = `<div class="charts">
    <div class="chart-card"><h3>Total Due by Month</h3><canvas id="${lineId}"></canvas></div>
    <div class="chart-card"><h3>Total Due by Stage</h3><canvas id="${barId}"></canvas></div>
  </div>`;

  target.innerHTML = kpiHTML + chartsHTML + `<div class="panel">${renderTable(rows)}</div>`;

  lineByMonth(lineId, rows, 'totaldue', dateField[report], 'Total Due', '#f59e0b');
  barGroupSum(barId, rows, 'totaldue', 'stage', 'Total Due', '#f59e0b');
}

function renderLiquidationsReport(data=null){
  const report='liquidations';
  const target=document.getElementById(`${report}-content`);
  const rows = data || getFiltered(report, dateField[report]);
  if(!rows.length){ target.innerHTML = `<div class="panel">No data for current filters.</div>`; return; }

  const totalIssued = sum(rows,'issuedamount');
  const totalPaid = sum(rows,'payment');
  const liqPct = totalIssued ? (totalPaid/totalIssued*100) : 0;

  const kpiHTML = `<div class="panel"><div class="kpis">
    <div class="kpi"><div class="label">Total Issued Amount</div><div class="value">${fmtMoney(totalIssued)}</div></div>
    <div class="kpi"><div class="label">Total Paid</div><div class="value">${fmtMoney(totalPaid)}</div></div>
    <div class="kpi"><div class="label">Liquidation %</div><div class="value">${liqPct.toFixed(1)}%</div></div>
  </div></div>`;

  const lineId='liq-line', barId='liq-bar';
  const chartsHTML = `<div class="charts">
    <div class="chart-card"><h3>Issued vs Paid by Month</h3><canvas id="${lineId}"></canvas></div>
    <div class="chart-card"><h3>Issued vs Paid by Stage</h3><canvas id="${barId}"></canvas></div>
  </div>`;

  target.innerHTML = kpiHTML + chartsHTML + `<div class="panel">${renderTable(rows)}</div>`;

  groupedLineByMonth(lineId, rows, 'issuedamount', 'payment', dateField[report], 'Issued', 'Paid', '#3b82f6', '#10b981');
  groupedBars(barId, rows, 'issuedamount', 'payment', 'stage', 'Issued', 'Paid', '#3b82f6', '#10b981');
}

/* -------------------- Simple generic for other tabs (kept) -------------------- */
function renderGeneric(report){
  const target=document.getElementById(`${report}-content`);
  const rows = reportData[report] || [];
  if(!rows.length){ target.innerHTML = `<div class="panel">No data.</div>`; return; }
  target.innerHTML = `<div class="panel">${renderTable(rows, 100)}</div>`;
}

/* -------------------- Nav -------------------- */
document.querySelectorAll('.nav-link').forEach(link=>{
  link.addEventListener('click',e=>{
    e.preventDefault();
    const page=link.dataset.page;
    document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
    link.classList.add('active');
    document.querySelectorAll('main .page').forEach(p=>p.classList.add('hidden'));
    document.getElementById(`${page}-page`).classList.remove('hidden');

    if(page==='lending-volume'){ buildFilters('lending-volume'); renderLendingReport(); }
    else if(page==='arrears'){ buildFilters('arrears'); renderArrearsReport(); }
    else if(page==='liquidations'){ buildFilters('liquidations'); renderLiquidationsReport(); }
    else if(page==='complaints'){ renderGeneric('complaints'); }
    else if(page==='financial-crime'){ renderGeneric('financial-crime'); }
  });
});

/* -------------------- Load all data once -------------------- */
async function loadAll(){
  for(const [rep,url] of Object.entries(dataSources)){
    try{
      const res = await fetch(url);
      const txt = await res.text();
      reportData[rep] = parseCSV(txt);
      console.log(`Loaded ${reportData[rep].length} rows for ${rep}`);
    }catch(err){
      console.error('Load error', rep, err);
      reportData[rep] = [];
    }
  }
}

document.addEventListener('DOMContentLoaded', async ()=>{
  await loadAll();
  // land on lending-volume for testing
  const first = document.querySelector('.nav-link[data-page="lending-volume"]');
  if(first) first.click();
});
</script>
