<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Financial Reports Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --blue:#3b82f6;
      --green:#10b981;
      --orange:#f59e0b;
      --red:#ef4444;
      --slate:#334155;
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e5e7eb;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#0f172a}
    .app{display:flex;min-height:100vh}
    .sidebar{width:240px;background:#fff;border-right:1px solid var(--border)}
    .sidebar-header{padding:16px 18px;font-weight:800;border-bottom:1px solid var(--border)}
    .nav-link{display:block;padding:12px 16px;color:var(--slate);text-decoration:none;cursor:pointer}
    .nav-link:hover{background:#f1f5f9}
    .nav-link.active{background:#eef6ff;border-left:3px solid var(--blue);color:#1d4ed8}
    main{flex:1;padding:24px}
    .hidden{display:none}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:18px}
    .filters{display:flex;gap:16px;row-gap:10px;flex-wrap:wrap;align-items:flex-end}
    .filters label{display:block;font-size:12px;font-weight:700;margin-bottom:6px;color:#475569}
    .filters select{min-width:150px;padding:6px;border-radius:8px;border:1px solid #cbd5e1}
    .filters select[multiple]{height:110px}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--border);border-radius:8px;cursor:pointer;background:#fff}
    .btn-primary{border-color:transparent;background:var(--blue);color:#fff}
    .btn-outline{background:#fff}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .kpi{background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:12px}
    .kpi .label{font-size:12px;color:#64748b}
    .kpi .value{font-size:20px;font-weight:800;margin-top:6px}
    .charts{display:grid;grid-template-columns:1fr;gap:16px}
    .chart-card h3{margin:0 0 8px;font-size:14px;color:#334155}
    .table-wrap{max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
    th{background:#f8fafc;position:sticky;top:0;z-index:1}
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="sidebar-header"><i class="fas fa-chart-line"></i> Financial Reports</div>
    <a class="nav-link active" data-page="overview">Overview</a>
    <a class="nav-link" data-page="lending-volume">Lending Volume</a>
    <a class="nav-link" data-page="liquidations">Liquidations</a>
    <a class="nav-link" data-page="complaints">Complaints</a>
    <a class="nav-link" data-page="financial-crime">Financial Crime</a>
  </aside>

  <main>
    <!-- Overview -->
    <section id="overview-page" class="page">
      <div class="panel"><h2>Welcome</h2><p>Data auto-loaded from <code>/shared-data/</code> CSVs in this repo.</p></div>
    </section>

    <!-- Lending -->
    <section id="lending-volume-page" class="page hidden">
      <div class="panel">
        <h2>Lending Volume</h2>
        <div id="lending-volume-filters" class="filters"></div>
        <button class="btn btn-outline" id="lending-volume-reset"><i class="fas fa-eraser"></i> Reset Filters</button>
      </div>
      <div id="lending-volume-content"></div>
    </section>

    <!-- Liquidations -->
    <section id="liquidations-page" class="page hidden">
      <div class="panel">
        <h2>Liquidations</h2>
        <div id="liquidations-filters" class="filters"></div>
        <button class="btn btn-outline" id="liquidations-reset"><i class="fas fa-eraser"></i> Reset Filters</button>
      </div>
      <div id="liquidations-content"></div>
    </section>

    <!-- Keep generic for these two (unchanged for now) -->
    <section id="complaints-page" class="page hidden">
      <div class="panel"><h2>Complaints</h2><div id="complaints-content"></div></div>
    </section>
    <section id="financial-crime-page" class="page hidden">
      <div class="panel"><h2>Financial Crime</h2><div id="financial-crime-content"></div></div>
    </section>
  </main>
</div>

<script>
/* -------------------- Data sources -------------------- */
const dataSources = {
  "lending-volume":"shared-data/lending_volume.csv",
  "liquidations":"shared-data/lending_volume.csv",
  "complaints":"shared-data/complaints.csv",
  "financial-crime":"shared-data/financial_crime.csv"
};

const dateField = {
  "lending-volume":"fundeddate",
  "liquidations":"fundeddate",   // was stagedate
  "complaints":"receiveddate",
  "financial-crime":"datereported"
};

const reportData = {};
const charts = {};

/* -------------------- Helpers -------------------- */
function normalizeHeader(h){
  return String(h||'').trim().toLowerCase().replace(/\s+/g,'');
}

function cleanNumber(v){
  if (v == null) return 0;
  let s = String(v).trim().replace(/\u00A0/g,'').replace(/Â/g,'');
  if (!s) return 0;
  let neg = false;
  if (/^\(.*\)$/.test(s)) { neg = true; s = s.slice(1,-1).trim(); }
  if (/^\d{1,3}(\.\d{3})+,\d{2}$/.test(s)) {
    s = s.replace(/\./g,'').replace(',', '.');  // 1.234.567,89 -> 1234567.89
  } else {
    s = s.replace(/[£€$,]/g,'');                // strip currency/thousands
  }
  const n = parseFloat(s);
  return Number.isFinite(n) ? (neg ? -n : n) : 0;
}

function toDateSafe(v){
  if (!v) return null;
  if (v instanceof Date) return isNaN(v) ? null : v;
  const s = String(v).trim();

  // Excel serial date (with optional fraction for time)
  if (/^\d+(\.\d+)?$/.test(s)) {
    const n = parseFloat(s);
    if (n > 20000 && n < 60000) {               // plausible Excel range
      const base = new Date(1899, 11, 30);      // Excel’s 0-day (accounting for 1900 leap bug)
      base.setDate(base.getDate() + Math.floor(n));
      if (n % 1) base.setTime(base.getTime() + ((n % 1) * 86400000));
      return base;
    }
  }

  // ISO-like YYYY-MM-DD (or with time)
  if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  // D/M/Y or M/D/Y (2 or 4-digit year)
  let m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (m) {
    const a = +m[1], b = +m[2], y = +m[3] < 100 ? 2000 + (+m[3]) : +m[3];
    if (a > 12 && b <= 12) return new Date(y, b-1, a); // D/M/Y
    if (b > 12 && a <= 12) return new Date(y, a-1, b); // M/D/Y
    return new Date(y, b-1, a);                         // default D/M/Y
  }

  const d = new Date(s);
  return isNaN(d) ? null : d;
}

function fmtMoney(n){ return "£"+(cleanNumber(n)).toLocaleString(undefined,{maximumFractionDigits:2}); }
function sum(rows,key){ return rows.reduce((a,r)=>a+cleanNumber(r[key]),0); }
function avg(rows,key){ const vals=rows.map(r=>cleanNumber(r[key])).filter(v=>v>0); return vals.length? vals.reduce((a,b)=>a+b,0)/vals.length : 0; }

/* -------------------- CSV Parser -------------------- */
function parseCSV(text){
  const lines = String(text||'').replace(/^\uFEFF/,'').split(/\r?\n/);
  const rows = lines.filter((l,i)=> i===0 || l.trim() !== '');
  if (!rows.length) return [];
  const head = rows[0];
  const count = (s)=>{let c=0,inQ=false;for(let i=0;i<head.length;i++){const ch=head[i];if(ch==='"') inQ=!inQ; else if(!inQ&&ch===s)c++;}return c;};
  const delim = (count('\t')>count(',')&&count('\t')>count(';'))?'\t':(count(';')>count(',')?';':',');

  const splitRow=(row)=>{const out=[];let cur='',inQ=false;
    for(let i=0;i<row.length;i++){
      const ch=row[i];
      if(ch==='"'){ if(inQ && row[i+1]==='"'){cur+='"';i++;} else inQ=!inQ; }
      else if(ch===delim && !inQ){ out.push(cur); cur=''; }
      else { cur+=ch; }
    }
    out.push(cur); return out;
  };

  const headers = splitRow(rows[0]).map(normalizeHeader);
  const data = [];
  for(let i=1;i<rows.length;i++){
    const parts = splitRow(rows[i]);
    if(!parts.length) continue;
    const rec={};
    headers.forEach((h,idx)=> rec[h]=(parts[idx]??'').trim().replace(/\uFFFD/g,''));
    if(Object.values(rec).some(v=>String(v).trim()!=='')) data.push(rec);
  }
  return data;
}

/* -------------------- Filters -------------------- */
function buildFilters(report){
  const container = document.getElementById(`${report}-filters`);
  const rows = reportData[report]||[];
  container.innerHTML = '';

  const df = dateField[report];
  const years=new Set(), months=new Set(), tiers=new Set(), stages=new Set();

  rows.forEach(r=>{
    const d = toDateSafe(r[df]);
    if(d){ years.add(d.getFullYear()); months.add(d.getMonth()+1); }
    if(r.tiername) tiers.add(r.tiername);
    if(r.stage) stages.add(r.stage);
  });

  const yList = Array.from(years).filter(y=>y>=1990&&y<=2100).sort((a,b)=>a-b);
  const mList = Array.from(months).sort((a,b)=>a-b);
  const tList = Array.from(tiers).sort();
  const sList = Array.from(stages).sort();

  const wrap=document.createElement('div'); wrap.className='filters';
  const mkMulti=(id,label,values,format=(x)=>x)=>{const div=document.createElement('div');
    div.innerHTML = `<label for="${id}">${label}</label>
      <select id="${id}" multiple>${values.map(v=>`<option value="${v}">${format(v)}</option>`).join('')}</select>`;
    wrap.appendChild(div); return div.querySelector('select');
  };

  const ySel = mkMulti(`${report}-year`,'Year',yList,String);
  const mSel = mkMulti(`${report}-month`,'Month',mList,v=>String(v).padStart(2,'0'));
  const tSel = mkMulti(`${report}-tiername`,'Tier',tList,String);
  const sSel = mkMulti(`${report}-stage`,'Stage',sList,String);

  [ySel,mSel,tSel,sSel].forEach(sel=> sel.addEventListener('change', ()=>{
    if(report==='lending-volume') renderLendingReport();
    else if(report==='arrears')   renderArrearsReport();
    else if(report==='liquidations') renderLiquidationsReport();
  }));

  const resetBtn=document.createElement('button');
  resetBtn.textContent="Reset Filters";
  resetBtn.className="btn btn-outline";
  resetBtn.onclick=()=>{
    [ySel,mSel,tSel,sSel].forEach(sel=>Array.from(sel.options).forEach(o=>o.selected=false));
    if(report==='lending-volume') renderLendingReport();
    else if(report==='arrears')   renderArrearsReport();
    else if(report==='liquidations') renderLiquidationsReport();
  };

  container.appendChild(wrap);
  container.appendChild(resetBtn);
}

function getFiltered(report, dfKey){
  const rows = reportData[report]||[];
  const ySel = Array.from(document.getElementById(report+'-year')?.selectedOptions||[]).map(o=>o.value);
  const mSel = Array.from(document.getElementById(report+'-month')?.selectedOptions||[]).map(o=>o.value);
  const tSel = Array.from(document.getElementById(report+'-tiername')?.selectedOptions||[]).map(o=>o.value);
  const sSel = Array.from(document.getElementById(report+'-stage')?.selectedOptions||[]).map(o=>o.value);

  return rows.filter(r=>{
    const d = toDateSafe(r[dfKey]);
    if (ySel.length && (!d || !ySel.includes(String(d.getFullYear())))) return false;
    if (mSel.length && (!d || !mSel.includes(String(d.getMonth()+1).padStart(2,'0')))) return false;
    if (tSel.length && !tSel.includes(r.tiername||'')) return false;
    if (sSel.length && !sSel.includes(r.stage||'')) return false;
    return true;
  });
}

/* -------------------- Chart helpers -------------------- */
function destroyChart(id){ if(charts[id]){ charts[id].destroy(); delete charts[id]; } }
function lineByMonth(id,rows,valField,df,label,color){
  const agg={};
  rows.forEach(r=>{
    const d=toDateSafe(r[df]); if(!d) return;
    const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    agg[k]=(agg[k]||0)+cleanNumber(r[valField]);
  });
  const labels=Object.keys(agg).sort();
  const values=labels.map(k=>agg[k]);
  destroyChart(id);
  charts[id]=new Chart(document.getElementById(id),{
    type:'line',
    data:{labels,datasets:[{label,data:values,borderColor:color,backgroundColor:color,tension:.2}]},
    options:{responsive:true,scales:{y:{beginAtZero:true}}}
  });
}
function groupedLineByMonth(id,rows,fA,fB,df,labelA,labelB,colA,colB){
  const aggA={},aggB={};
  rows.forEach(r=>{
    const d=toDateSafe(r[df]); if(!d) return;
    const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    aggA[k]=(aggA[k]||0)+cleanNumber(r[fA]);
    aggB[k]=(aggB[k]||0)+cleanNumber(r[fB]);
  });
  const labels=Array.from(new Set([...Object.keys(aggA),...Object.keys(aggB)])).sort();
  const vA=labels.map(k=>aggA[k]||0);
  const vB=labels.map(k=>aggB[k]||0);
  destroyChart(id);
  charts[id]=new Chart(document.getElementById(id),{
    type:'line',
    data:{labels,datasets:[{label:labelA,data:vA,borderColor:colA,backgroundColor:colA,tension:.2},{label:labelB,data:vB,borderColor:colB,backgroundColor:colB,tension:.2}]},
    options:{responsive:true,scales:{y:{beginAtZero:true}}}
  });
}
function barGroupSum(id,rows,sumField,cat,label,color){
  const sums={};
  rows.forEach(r=>{
    const k=r[cat]||'Unknown';
    sums[k]=(sums[k]||0)+cleanNumber(r[sumField]);
  });
  const labels=Object.keys(sums).sort();
  const values=labels.map(k=>sums[k]);
  destroyChart(id);
  charts[id]=new Chart(document.getElementById(id),{
    type:'bar',
    data:{labels,datasets:[{label,data:values,backgroundColor:color}]},
    options:{responsive:true,scales:{y:{beginAtZero:true}}}
  });
}
function groupedBars(id,rows,fA,fB,cat,labelA,labelB,colA,colB){
  const sumsA={},sumsB={};
  rows.forEach(r=>{
    const k=r[cat]||'Unknown';
    sumsA[k]=(sumsA[k]||0)+cleanNumber(r[fA]);
    sumsB[k]=(sumsB[k]||0)+cleanNumber(r[fB]);
  });
  const labels=Array.from(new Set([...Object.keys(sumsA),...Object.keys(sumsB)])).sort();
  const vA=labels.map(l=>sumsA[l]||0);
  const vB=labels.map(l=>sumsB[l]||0);
  destroyChart(id);
  charts[id]=new Chart(document.getElementById(id),{
    type:'bar',
    data:{labels,datasets:[{label:labelA,data:vA,backgroundColor:colA},{label:labelB,data:vB,backgroundColor:colB}]},
    options:{responsive:true,scales:{y:{beginAtZero:true}}}
  });
}

/* -------------------- Tables -------------------- */
function renderTable(rows,maxRows=100){
  if(!rows.length)return '';
  const headers=Object.keys(rows[0]);
  const head=`<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
  const body=`<tbody>${rows.slice(0,maxRows).map(r=>`<tr>${headers.map(h=>`<td>${r[h]??''}</td>`).join('')}</tr>`).join('')}</tbody>`;
  return `<div class="table-wrap"><table>${head}${body}</table></div>`;
}

/* -------------------- Renderers -------------------- */
function renderLendingReport(){
  const rep='lending-volume';
  const target=document.getElementById(`${rep}-content`);
  const rows=getFiltered(rep,dateField[rep]);
  if(!rows.length){target.innerHTML=`<div class="panel">No data.</div>`;return;}
  const totalIssued=sum(rows,'issuedamount');
  const avgIssued=avg(rows,'issuedamount');
  const fundedCount=rows.length;
  const kpi=`<div class="panel"><div class="kpis">
      <div class="kpi"><div class="label">Total Issued</div><div class="value">${fmtMoney(totalIssued)}</div></div>
      <div class="kpi"><div class="label">Average Issued</div><div class="value">${fmtMoney(avgIssued)}</div></div>
      <div class="kpi"><div class="label">Funded Count</div><div class="value">${fundedCount.toLocaleString()}</div></div>
    </div></div>`;
  const lineId='lv-line', barId='lv-bar';
  const chartsHTML=`<div class="charts">
      <div class="chart-card"><h3>Issued Amount by Month</h3><canvas id="${lineId}"></canvas></div>
      <div class="chart-card"><h3>Issued Amount by Tier</h3><canvas id="${barId}"></canvas></div>
    </div>`;
  target.innerHTML=kpi+chartsHTML+`<div class="panel">${renderTable(rows)}</div>`;
  lineByMonth(lineId,rows,'issuedamount',dateField[rep],'Issued','#3b82f6');
  barGroupSum(barId,rows,'issuedamount','tiername','Issued','#3b82f6');
}

function renderLiquidationsReport(){
  const report='liquidations';
  const target=document.getElementById(`${report}-content`);
  const rows=getFiltered(report, dateField[report]);
  if(!rows.length){ target.innerHTML = `<div class="panel">No data.</div>`; return; }

  const totalIssued = sum(rows,'issuedamount');
  const totalPaid   = sum(rows,'payment');
  const totalDue    = sum(rows,'totaldue');
  const liqPct      = totalIssued ? (totalPaid/totalIssued*100) : 0;

  const kpiHTML = `
    <div class="panel"><div class="kpis">
      <div class="kpi"><div class="label">Total Issued Amount</div><div class="value">${fmtMoney(totalIssued)}</div></div>
      <div class="kpi"><div class="label">Total Paid</div><div class="value">${fmtMoney(totalPaid)}</div></div>
      <div class="kpi"><div class="label">Total Due</div><div class="value">${fmtMoney(totalDue)}</div></div>
      <div class="kpi"><div class="label">Liquidation %</div><div class="value">${liqPct.toFixed(1)}%</div></div>
    </div></div>
  `;

  const lineId='liq-line', barId='liq-bar';
  const chartsHTML = `
    <div class="charts">
      <div class="chart-card"><h3>Issued vs Paid vs Due by Month</h3><canvas id="${lineId}"></canvas></div>
      <div class="chart-card"><h3>Issued vs Paid vs Due by Stage</h3><canvas id="${barId}"></canvas></div>
    </div>
  `;

  target.innerHTML = kpiHTML + chartsHTML + `<div class="panel">${renderTable(rows)}</div>`;

  // Line: Issued, Paid, Due by month
  const aggIssued={}, aggPaid={}, aggDue={};
  rows.forEach(r=>{
    const d = toDateSafe(r[dateField[report]]); if(!d) return;
    const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    aggIssued[k]=(aggIssued[k]||0)+cleanNumber(r['issuedamount']);
    aggPaid[k]=(aggPaid[k]||0)+cleanNumber(r['payment']);
    aggDue[k]=(aggDue[k]||0)+cleanNumber(r['totaldue']);
  });
  const labels = Array.from(new Set([...Object.keys(aggIssued),...Object.keys(aggPaid),...Object.keys(aggDue)])).sort();
  const vIssued = labels.map(k=>aggIssued[k]||0);
  const vPaid   = labels.map(k=>aggPaid[k]||0);
  const vDue    = labels.map(k=>aggDue[k]||0);

  destroyChart(lineId);
  charts[lineId]=new Chart(document.getElementById(lineId),{
    type:'line',
    data:{ labels, datasets:[
      {label:'Issued', data:vIssued, borderColor:'#3b82f6', backgroundColor:'#3b82f6', tension:.2, fill:false},
      {label:'Paid', data:vPaid, borderColor:'#10b981', backgroundColor:'#10b981', tension:.2, fill:false},
      {label:'Due', data:vDue, borderColor:'#f59e0b', backgroundColor:'#f59e0b', tension:.2, fill:false}
    ]},
    options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
  });

  // Bar: Issued, Paid, Due by Stage
  const sumsIssued={}, sumsPaid={}, sumsDue={};
  rows.forEach(r=>{
    const k=r['stage']||'Unknown';
    sumsIssued[k]=(sumsIssued[k]||0)+cleanNumber(r['issuedamount']);
    sumsPaid[k]=(sumsPaid[k]||0)+cleanNumber(r['payment']);
    sumsDue[k]=(sumsDue[k]||0)+cleanNumber(r['totaldue']);
  });
  const cats = Array.from(new Set([...Object.keys(sumsIssued),...Object.keys(sumsPaid),...Object.keys(sumsDue)])).sort();
  const bIssued = cats.map(k=>sumsIssued[k]||0);
  const bPaid   = cats.map(k=>sumsPaid[k]||0);
  const bDue    = cats.map(k=>sumsDue[k]||0);

  destroyChart(barId);
  charts[barId]=new Chart(document.getElementById(barId),{
    type:'bar',
    data:{ labels:cats, datasets:[
      {label:'Issued', data:bIssued, backgroundColor:'#3b82f6'},
      {label:'Paid', data:bPaid, backgroundColor:'#10b981'},
      {label:'Due', data:bDue, backgroundColor:'#f59e0b'}
    ]},
    options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
  });
}

function renderComplaintsReport(){
  const report='complaints';
  const target=document.getElementById(`${report}-content`);
  const rows=reportData[report]||[];
  if(!rows.length){ target.innerHTML=`<div class="panel">No data.</div>`; return; }

  const totalComplaints = rows.length;
  const avgResolve = avg(rows,'daystoresolve');
  const pctResolved8w = totalComplaints ? 
    (rows.filter(r=>cleanNumber(r.daystoresolve) <= 56).length / totalComplaints * 100) : 0;

  const kpiHTML = `
    <div class="panel"><div class="kpis">
      <div class="kpi"><div class="label">Total Complaints</div><div class="value">${totalComplaints}</div></div>
      <div class="kpi"><div class="label">Avg Days to Resolve</div><div class="value">${avgResolve.toFixed(1)}</div></div>
      <div class="kpi"><div class="label">% Resolved ≤ 8 Weeks</div><div class="value">${pctResolved8w.toFixed(1)}%</div></div>
    </div></div>
  `;

  const lineId='comp-line', barId='comp-bar', pieId='comp-pie';
  const chartsHTML=`
    <div class="charts">
      <div class="chart-card"><h3>Complaints Over Time</h3><canvas id="${lineId}"></canvas></div>
      <div class="chart-card"><h3>By Category</h3><canvas id="${barId}"></canvas></div>
      <div class="chart-card"><h3>By Decision</h3><canvas id="${pieId}"></canvas></div>
    </div>
  `;

  target.innerHTML=kpiHTML+chartsHTML+`<div class="panel">${renderTable(rows)}</div>`;

  // --- Line: complaints over time (count rows)
  const agg={};
  rows.forEach(r=>{
    const d=toDateSafe(r[dateField[report]]); if(!d) return;
    const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    agg[k]=(agg[k]||0)+1;
  });
  const labels=Object.keys(agg).sort();
  const values=labels.map(k=>agg[k]);
  destroyChart(lineId);
  charts[lineId]=new Chart(document.getElementById(lineId),{
    type:'line',
    data:{ labels, datasets:[{ label:'Complaints', data:values, borderColor:'#3b82f6', backgroundColor:'#3b82f6', tension:.2 }] },
    options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
  });

  // --- Bar: complaints by category
  barGroupSum(barId, rows, 'count', 'category', 'Complaints', '#f59e0b');

  // --- Pie: complaints by decision
  const sums={};
  rows.forEach(r=>{ const k=r['decision']||'Unknown'; sums[k]=(sums[k]||0)+1; });
  destroyChart(pieId);
  charts[pieId]=new Chart(document.getElementById(pieId),{
    type:'pie',
    data:{ labels:Object.keys(sums), datasets:[{data:Object.values(sums), backgroundColor:['#3b82f6','#10b981','#f59e0b','#ef4444']}] },
    options:{ responsive:true }
  });
}

function renderFinancialCrimeReport(){
  const report='financial-crime';
  const target=document.getElementById(`${report}-content`);
  const rows=reportData[report]||[];
  if(!rows.length){ target.innerHTML=`<div class="panel">No data.</div>`; return; }

  const totalCases = rows.length;
  const totalPrincipal = sum(rows,'principal');
  const avgPrincipal = avg(rows,'principal');
  const totalInterest = sum(rows,'interest');

  const kpiHTML = `
    <div class="panel"><div class="kpis">
      <div class="kpi"><div class="label">Total Cases</div><div class="value">${totalCases}</div></div>
      <div class="kpi"><div class="label">Total Principal</div><div class="value">${fmtMoney(totalPrincipal)}</div></div>
      <div class="kpi"><div class="label">Avg Principal</div><div class="value">${fmtMoney(avgPrincipal)}</div></div>
      <div class="kpi"><div class="label">Total Interest</div><div class="value">${fmtMoney(totalInterest)}</div></div>
    </div></div>
  `;

  const lineId='fc-line', barId='fc-bar', pieId='fc-pie';
  const chartsHTML=`
    <div class="charts">
      <div class="chart-card"><h3>Cases Over Time</h3><canvas id="${lineId}"></canvas></div>
      <div class="chart-card"><h3>Principal by Loan Source</h3><canvas id="${barId}"></canvas></div>
      <div class="chart-card"><h3>By Decision</h3><canvas id="${pieId}"></canvas></div>
    </div>
  `;

  target.innerHTML=kpiHTML+chartsHTML+`<div class="panel">${renderTable(rows)}</div>`;

  // --- Line: cases over time (count rows)
  const agg={};
  rows.forEach(r=>{
    const d=toDateSafe(r[dateField[report]]); if(!d) return;
    const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    agg[k]=(agg[k]||0)+1;
  });
  const labels=Object.keys(agg).sort();
  const values=labels.map(k=>agg[k]);
  destroyChart(lineId);
  charts[lineId]=new Chart(document.getElementById(lineId),{
    type:'line',
    data:{ labels, datasets:[{ label:'Cases', data:values, borderColor:'#3b82f6', backgroundColor:'#3b82f6', tension:.2 }] },
    options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
  });

  // --- Bar: principal by loan source
  barGroupSum(barId, rows, 'principal', 'loansource', 'Principal', '#f59e0b');

  // --- Pie: cases by decision
  const sums={};
  rows.forEach(r=>{ const k=r['decision']||'Unknown'; sums[k]=(sums[k]||0)+1; });
  destroyChart(pieId);
  charts[pieId]=new Chart(document.getElementById(pieId),{
    type:'pie',
    data:{ labels:Object.keys(sums), datasets:[{data:Object.values(sums), backgroundColor:['#3b82f6','#10b981','#f59e0b','#ef4444']}] },
    options:{ responsive:true }
  });
}

/* -------------------- Navigation + load -------------------- */
document.querySelectorAll('.nav-link').forEach(link=>{
  link.addEventListener('click',e=>{
    e.preventDefault();
    const page=link.dataset.page;
    document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
    link.classList.add('active');
    document.querySelectorAll('main .page').forEach(p=>p.classList.add('hidden'));
    document.getElementById(`${page}-page`).classList.remove('hidden');

    if(page==='lending-volume'){ buildFilters('lending-volume'); renderLendingReport(); }
    else if(page==='liquidations'){ buildFilters('liquidations'); renderLiquidationsReport(); }
    else if(page==='complaints'){ renderComplaintsReport(); }
    else if(page==='financial-crime'){ renderFinancialCrimeReport(); }
  });
});

async function loadAll(){
  for(const [rep,url] of Object.entries(dataSources)){
    try{
      const res = await fetch(url);
      const txt = await res.text();
      reportData[rep] = parseCSV(txt);
      // no console spam in prod
    }catch(err){
      console.error('Load error', rep, err);
      reportData[rep] = [];
    }
  }
}

document.addEventListener('DOMContentLoaded', async ()=>{
  await loadAll();
  const first = document.querySelector('.nav-link[data-page="lending-volume"]');
  if(first) first.click();
});
</script>
