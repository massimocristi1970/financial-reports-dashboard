<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Financial Reports Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin:0; background:#f8fafc; color:#0f172a; }
    .app-container { display:flex; min-height:100vh; }
    .sidebar { width:260px; background:#fff; border-right:1px solid #e2e8f0; }
    .sidebar-header { padding:18px 20px; font-weight:700; border-bottom:1px solid #e2e8f0; }
    .nav-link { cursor:pointer; padding:12px 18px; display:flex; gap:10px; align-items:center; color:#334155; }
    .nav-link:hover { background:#f1f5f9; }
    .nav-link.active { background:#eef6ff; border-left:3px solid #3b82f6; color:#1d4ed8; }
    .main-content { flex:1; padding:24px; }
    .page-header { margin-bottom:16px; }
    .page-title { font-size:24px; font-weight:800; }
    .hidden { display:none; }
    .panel { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:18px; margin-bottom:18px; }
    .filters { display:flex; gap:16px; row-gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .filters label { font-size:12px; font-weight:700; color:#475569; display:block; margin-bottom:6px; }
    .filters select { min-width:140px; padding:8px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; }
    .filters select[multiple]{ min-width:200px; height:112px; }
    .kpi-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:14px; }
    .kpi { background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:14px 16px; }
    .kpi .label { font-size:12px; color:#64748b; }
    .kpi .value { font-size:22px; font-weight:800; margin-top:6px; }
    .charts-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap:16px; }
    .chart-card h3 { margin:0 0 8px 0; font-size:14px; color:#334155; }
    .data-table table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 12px; border-bottom:1px solid #e5e7eb; text-align:left; white-space:nowrap; }
    th { background:#f8fafc; position:sticky; top:0; z-index:1; }
    .table-wrap { max-height:420px; overflow:auto; border:1px solid #e5e7eb; border-radius:12px; }
    .small { color:#64748b; font-size:12px; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header"><i class="fas fa-chart-line"></i> Financial Reports</div>
      <nav>
        <div class="nav-link active" onclick="showPage(event,'overview')"><i class="fas fa-home"></i> Overview</div>
        <div class="nav-link" onclick="showPage(event,'data-management')"><i class="fas fa-upload"></i> Data Management</div>
        <div class="nav-link" onclick="showPage(event,'lending-volume')"><i class="fas fa-coins"></i> Lending Volume</div>
        <div class="nav-link" onclick="showPage(event,'arrears')"><i class="fas fa-exclamation-triangle"></i> Arrears</div>
        <div class="nav-link" onclick="showPage(event,'liquidations')"><i class="fas fa-sync"></i> Liquidations</div>
        <div class="nav-link" onclick="showPage(event,'complaints')"><i class="fas fa-clipboard-list"></i> Complaints</div>
        <div class="nav-link" onclick="showPage(event,'financial-crime')"><i class="fas fa-user-shield"></i> Financial Crime</div>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="main-content">
      <!-- Overview -->
      <section id="overview-page">
        <div class="page-header"><div class="page-title">Welcome</div></div>
        <div class="panel small">Upload CSVs under <strong>Data Management</strong>, then explore reports.</div>
      </section>

      <!-- Data Management -->
      <section id="data-management-page" class="hidden">
        <div class="page-header"><div class="page-title">Data Management</div></div>
        <div class="panel"><h3>Lending Volume</h3><input type="file" accept=".csv,.tsv" onchange="uploadFile(this,'lending-volume')"/><div id="lending-volume-status" class="small"></div></div>
        <div class="panel"><h3>Arrears</h3><input type="file" accept=".csv,.tsv" onchange="uploadFile(this,'arrears')"/><div id="arrears-status" class="small"></div></div>
        <div class="panel"><h3>Liquidations</h3><input type="file" accept=".csv,.tsv" onchange="uploadFile(this,'liquidations')"/><div id="liquidations-status" class="small"></div></div>
        <div class="panel"><h3>Complaints</h3><input type="file" accept=".csv,.tsv" onchange="uploadFile(this,'complaints')"/><div id="complaints-status" class="small"></div></div>
        <div class="panel"><h3>Financial Crime</h3><input type="file" accept=".csv,.tsv" onchange="uploadFile(this,'financial-crime')"/><div id="financial-crime-status" class="small"></div></div>
      </section>

      <!-- Report pages -->
      <section id="lending-volume-page" class="hidden"><div class="page-header"><div class="page-title">Lending Volume</div></div><div id="lending-volume-filters" class="panel"></div><div id="lending-volume-content"></div></section>
      <section id="arrears-page" class="hidden"><div class="page-header"><div class="page-title">Arrears</div></div><div id="arrears-filters" class="panel"></div><div id="arrears-content"></div></section>
      <section id="liquidations-page" class="hidden"><div class="page-header"><div class="page-title">Liquidations</div></div><div id="liquidations-filters" class="panel"></div><div id="liquidations-content"></div></section>
      <section id="complaints-page" class="hidden"><div class="page-header"><div class="page-title">Complaints</div></div><div id="complaints-filters" class="panel"></div><div id="complaints-content"></div></section>
      <section id="financial-crime-page" class="hidden"><div class="page-header"><div class="page-title">Financial Crime</div></div><div id="financial-crime-filters" class="panel"></div><div id="financial-crime-content"></div></section>
    </main>
  </div>

  <script>
const reportData = { 'lending-volume':[], 'arrears':[], 'liquidations':[], 'complaints':[], 'financial-crime':[] };
const charts = {};

// ---------- Helpers ----------
function cleanNumber(x){
  if(x===null||x===undefined) return NaN;
  let s=String(x).trim();
  if(!s) return NaN;
  let neg=false;
  if(/^\(.*\)$/.test(s)){ neg=true; s=s.slice(1,-1); }
  s=s.replace(/[£,\s]/g,'');
  const n=parseFloat(s);
  return isNaN(n)?NaN:(neg?-n:n);
}
function numericList(data,f){ const arr=[]; for(const r of data){const v=r[f];if(v!==undefined&&String(v).trim()!==''){const n=cleanNumber(v);if(!isNaN(n))arr.push(n);} } return arr;}
function sumField(data,f){return numericList(data,f).reduce((a,b)=>a+b,0);}
function avgField(data,f){const arr=numericList(data,f);return arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:0;}
function fmtMoney(n){return (Number.isFinite(n)?n:0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});}
function escapeHtml(str){return String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));}
function toDate(v){if(!v) return NaN;const d=new Date(v);if(!isNaN(d))return d;const m=String(v).match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);return m?new Date(+m[3],+m[2]-1,+m[1]):new Date(v);}
function uniqueSorted(arr){return Array.from(new Set(arr)).sort((a,b)=>(''+a).localeCompare((''+b),undefined,{numeric:true}));}

// ---------- CSV Parser ----------
function parseCSV(text){
  const lines=String(text||'').replace(/^\uFEFF/,'').split(/\r?\n/).filter(l=>l.trim());
  if(!lines.length) return [];
  const delim=detectDelimiter(lines[0]);
  const headers=splitRow(lines[0],delim);
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const parts=splitRow(lines[i],delim);
    if(!parts.length) continue;
    const rec={}; headers.forEach((h,j)=>rec[h]=(parts[j]||'').replace(/\uFFFD/g,'').trim());
    rows.push(rec);
  }
  return rows;
}
function detectDelimiter(line){let c=(d)=>{let cnt=0,inQ=false;for(let i=0;i<line.length;i++){if(line[i]==='"')inQ=!inQ;else if(!inQ&&line[i]===d)cnt++;}return cnt;};return c('\t')>c(',')?'\t':',';}
function splitRow(row,delim){const out=[];let cur='',inQ=false;for(let i=0;i<row.length;i++){const ch=row[i];if(ch==='"'){if(inQ&&row[i+1]==='"'){cur+='"';i++;}else inQ=!inQ;}else if(ch===delim&&!inQ){out.push(cur);cur='';}else cur+=ch;}out.push(cur);return out;}

// ---------- Configs ----------
const reportConfigs={
  'lending-volume':{dateField:'FundedDate',filterFields:['TierName','Stage'],
    kpis:d=>{const t=d.length;const tot=sumField(d,'IssuedAmount');const avg=avgField(d,'IssuedAmount');return[
      {label:'Total Loans',value:t.toLocaleString()},{label:'Total Issued',value:'£'+fmtMoney(tot)},{label:'Average Issued',value:'£'+fmtMoney(avg)}];},defaultGroup:'Stage'},
  'arrears':{dateField:'StageDate',filterFields:['TierName','Stage'],
    kpis:d=>{const totIssued=sumField(d,'IssuedAmount');const totDue=sumField(d,'TotalDue');return[
      {label:'Total Issued Amount',value:'£'+fmtMoney(totIssued)},{label:'Total Due',value:'£'+fmtMoney(totDue)}];},
    defaultGroup:'Stage',chartMode:'due'},
  'liquidations':{dateField:'StageDate',filterFields:['TierName','Stage'],
    kpis:d=>{const totIssued=sumField(d,'IssuedAmount');const totPaid=sumField(d,'Payment');const pct=totIssued?(totPaid/totIssued*100):0;return[
      {label:'Total Issued Amount',value:'£'+fmtMoney(totIssued)},{label:'Total Paid',value:'£'+fmtMoney(totPaid)},{label:'Liquidation %',value:pct.toFixed(1)+'%'}];},
    defaultGroup:'Stage',chartMode:'compare-issued-paid'},
  'complaints':{dateField:'ReceivedDate',filterFields:['Category','Decision'],
    kpis:d=>{const tot=sumField(d,'Count')||d.length;const avg=avgField(d,'DaysToResolve');const open=d.filter(r=>!r['ResolvedDate']).length;return[
      {label:'Total Complaints',value:tot.toLocaleString()},{label:'Avg Days to Resolve',value:avg.toFixed(1)},{label:'Open (no ResolvedDate)',value:open.toLocaleString()}];},defaultGroup:'Category'},
  'financial-crime':{dateField:'Date Reported',filterFields:['Loan Source','AppStatus','Decision'],
    kpis:d=>{const t=d.length;const tot=sumField(d,'Principal');const avg=avgField(d,'Principal');return[
      {label:'Total Cases',value:t.toLocaleString()},{label:'Total Principal',value:'£'+fmtMoney(tot)},{label:'Average Principal',value:'£'+fmtMoney(avg)}];},defaultGroup:'Decision'}
};

// ---------- Nav ----------
function showPage(e,id){
  document.querySelectorAll('[id$="-page"]').forEach(p=>p.classList.add('hidden'));
  document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
  document.getElementById(id+'-page').classList.remove('hidden');
  if(e)e.currentTarget.classList.add('active');
  if(reportConfigs[id]){buildFiltersUI(id);renderReport(id);}
}
function uploadFile(inp,type){
  const f=inp.files?.[0];if(!f)return;
  const r=new FileReader();
  r.onload=e=>{reportData[type]=parseCSV(e.target.result);
    document.getElementById(type+'-status').textContent=`Loaded ${reportData[type].length} records`;
    buildFiltersUI(type);renderReport(type);};
  r.readAsText(f);
}

// ---------- Filters ----------
function buildFiltersUI(type){
  const container=document.getElementById(`${type}-filters`);
  const cfg=reportConfigs[type];
  const data=reportData[type]||[];
  container.innerHTML='';
  const wrap=document.createElement('div');wrap.className='filters';

  const years=uniqueSorted(data.map(r=>{const d=toDate(r[cfg.dateField]);return isNaN(d)?null:d.getFullYear();}).filter(Boolean));
  wrap.appendChild(selectBlock(`${type}-year`,'Year',years,false,true,()=>updateReport(type)));
  const months=Array.from({length:12},(_,i)=>String(i+1).padStart(2,'0'));
  wrap.appendChild(selectBlock(`${type}-month`,'Month',months,false,true,()=>updateReport(type)));
  (cfg.filterFields||[]).forEach(field=>{
    const vals=uniqueSorted(data.map(r=>r[field]||'Unknown'));
    wrap.appendChild(selectBlock(`${type}-filter-${slug(field)}`,field,vals,true,true,()=>updateReport(type)));
  });
  container.appendChild(wrap);
}
function selectBlock(id,labelText,values,multiple=false,includeAll=false,onChange=()=>{}){
  const block=document.createElement('div');
  const lab=document.createElement('label');lab.setAttribute('for',id);lab.textContent=labelText;
  const sel=document.createElement('select');sel.id=id;
  if(multiple) sel.multiple=true;
  if(multiple) sel.size=Math.min(6,Math.max(4,values.length));
  if(includeAll){sel.appendChild(new Option('All',''));}
  values.forEach(v=>sel.appendChild(new Option(v,v)));
  sel.onchange=onChange;
  block.appendChild(lab);block.appendChild(sel);
  return block;
}

// ---------- Render ----------
function updateReport(type){renderReport(type);}
function renderReport(type){
  const content=document.getElementById(`${type}-content`);
  const cfg=reportConfigs[type];
  const dataRaw=reportData[type]||[];
  if(!dataRaw.length){content.innerHTML=`<div class="panel small">No data uploaded.</div>`;return;}
  const data=applyFilters(type,dataRaw,cfg);
  if(!data.length){content.innerHTML=`<div class="panel small">No data for selected filters.</div>`;return;}

  const kpiItems=cfg.kpis(data);
  const kpiHtml=`<div class="panel"><div class="kpi-grid">${kpiItems.map(k=>`<div class="kpi"><div class="label">${k.label}</div><div class="value">${k.value}</div></div>`).join('')}</div></div>`;

  let chartData, chartTitle='By '+cfg.defaultGroup;
  if(cfg.chartMode==='compare-issued-paid'){ // Liquidations
    const {groupField,title}=decideGrouping(type,cfg); chartTitle=title;
    const grouped={};
    data.forEach(r=>{const key=(groupField==='YEAR')?(toDate(r[cfg.dateField])?.getFullYear()||'Unknown'):(r[groupField]||'Unknown');
      if(!grouped[key]) grouped[key]={issued:0,paid:0};
      grouped[key].issued+=cleanNumber(r['IssuedAmount']);
      grouped[key].paid+=cleanNumber(r['Payment']);});
    const labels=Object.keys(grouped);
    chartData={labels,datasets:[
      {label:'Issued',data:labels.map(l=>grouped[l].issued),backgroundColor:'rgba(59,130,246,0.6)',borderColor:'rgba(59,130,246,1)'},
      {label:'Paid',data:labels.map(l=>grouped[l].paid),backgroundColor:'rgba(16,185,129,0.6)',borderColor:'rgba(16,185,129,1)'}
    ]};
  } else if(cfg.chartMode==='due'){ // Arrears
    const {groupField,title}=decideGrouping(type,cfg); chartTitle=title;
    const grouped={};
    data.forEach(r=>{const key=(groupField==='YEAR')?(toDate(r[cfg.dateField])?.getFullYear()||'Unknown'):(r[groupField]||'Unknown');
      if(!grouped[key]) grouped[key]=0;
      grouped[key]+=cleanNumber(r['TotalDue']);});
    const labels=Object.keys(grouped);
    chartData={labels,datasets:[{label:'Total Due',data:labels.map(l=>grouped[l]),backgroundColor:'rgba(239,68,68,0.6)',borderColor:'rgba(239,68,68,1)'}]};
  } else {
    const {groupField,title}=decideGrouping(type,cfg); chartTitle=title;
    const {labels,values}=groupData(data,groupField,cfg);
    chartData={labels,datasets:[{label:'Count',data:values,backgroundColor:'rgba(59,130,246,0.6)',borderColor:'rgba(59,130,246,1)'}]};
  }

  const barId=`${type}-bar`,lineId=`${type}-line`,pieId=`${type}-pie`;
  const chartsHtml=`<div class="charts-grid">
    <div class="panel chart-card"><h3>${chartTitle} (Bar)</h3><canvas id="${barId}"></canvas></div>
    <div class="panel chart-card"><h3>${chartTitle} (Line)</h3><canvas id="${lineId}"></canvas></div>
    <div class="panel chart-card"><h3>${chartTitle} (Pie)</h3><canvas id="${pieId}"></canvas></div>
  </div>`;

  const headers=Object.keys(data[0]);
  const table=`<div class="panel data-table"><div class="small">Showing first 100 rows (${data.length.toLocaleString()} total)</div><div class="table-wrap"><table>
    <thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
    <tbody>${data.slice(0,100).map(r=>`<tr>${headers.map(h=>`<td>${escapeHtml(r[h]||'')}</td>`).join('')}</tr>`).join('')}</tbody>
  </table></div></div>`;

  content.innerHTML=kpiHtml+chartsHtml+table;
  drawCharts(type,{barId,lineId,pieId},chartData.labels,chartData.datasets);
}

// ---------- Filtering + grouping ----------
function applyFilters(type,data,cfg){
  const year=document.getElementById(`${type}-year`)?.value||'';
  const month=document.getElementById(`${type}-month`)?.value||'';
  const selected={};
  (cfg.filterFields||[]).forEach(f=>{
    const sel=document.getElementById(`${type}-filter-${slug(f)}`);
    const vals=Array.from(sel?.selectedOptions||[]).map(o=>o.value).filter(v=>v!=='');
    selected[f]=vals;
  });
  return data.filter(r=>{
    const dt=toDate(r[cfg.dateField]);
    if(year && (!dt||String(dt.getFullYear())!==String(year))) return false;
    if(month && (!dt||String(dt.getMonth()+1).padStart(2,'0')!==String(month))) return false;
    for(const f of (cfg.filterFields||[])){
      const vals=selected[f];
      if(vals.length && !vals.includes(r[f]||'Unknown')) return false;
    }
    return true;
  });
}
function decideGrouping(type,cfg){
  const fA=cfg.filterFields?.[0];const fB=cfg.filterFields?.[1];
  const aSel=Array.from(document.getElementById(`${type}-filter-${slug(fA)}`)?.selectedOptions||[]).map(o=>o.value).filter(v=>v!=='');
  const bSel=fB?Array.from(document.getElementById(`${type}-filter-${slug(fB)}`)?.selectedOptions||[]).map(o=>o.value).filter(v=>v!==''):[];
  if(aSel.length && !bSel.length && fB) return {groupField:fB,title:`By ${fB}`};
  if(bSel.length && fA) return {groupField:fA,title:`By ${fA}`};
  if(aSel.length && bSel.length) return {groupField:'YEAR',title:'By Year'};
  return {groupField:cfg.defaultGroup||fA||'YEAR',title:`By ${cfg.defaultGroup||fA||'Year'}`};
}
function groupData(data,groupField,cfg){
  if(groupField==='YEAR'){
    const map={};data.forEach(r=>{const d=toDate(r[cfg.dateField]);const k=(!d||isNaN(d))?'Unknown':String(d.getFullYear());map[k]=(map[k]||0)+1;});
    const labels=Object.keys(map);return {labels,values:labels.map(l=>map[l])};
  } else {
    const map={};data.forEach(r=>{const k=r[groupField]||'Unknown';map[k]=(map[k]||0)+1;});
    const labels=Object.keys(map);return {labels,values:labels.map(l=>map[l])};
  }
}

// ---------- Charts ----------
function drawCharts(type,ids,labelsOrData,datasetsOrUndefined){
  charts[type]?.bar?.destroy();charts[type]?.line?.destroy();charts[type]?.pie?.destroy();

  let labels, datasets;
  if(Array.isArray(labelsOrData) && Array.isArray(datasetsOrUndefined)){
    labels=labelsOrData;datasets=datasetsOrUndefined;
  } else {
    labels=labelsOrData;datasets=[{label:'Count',data:datasetsOrUndefined,borderWidth:1}];
  }

  charts[type]={};
  charts[type].bar=new Chart(document.getElementById(ids.barId),{type:'bar',data:{labels,datasets},options:{responsive:true,plugins:{legend:{display:true}},scales:{y:{beginAtZero:true}}}});
  charts[type].line=new Chart(document.getElementById(ids.lineId),{type:'line',data:{labels,datasets},options:{responsive:true,plugins:{legend:{display:true}},scales:{y:{beginAtZero:true}}}});
  charts[type].pie=new Chart(document.getElementById(ids.pieId),{type:'pie',data:{labels,datasets},options:{responsive:true,plugins:{legend:{position:'bottom'}}}});
}

// ---------- Utils ----------
function slug(s){return String(s).toLowerCase().replace(/\s+/g,'-');}
</script>
