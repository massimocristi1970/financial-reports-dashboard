<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Financial Reports Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --blue:#3b82f6;
      --green:#10b981;
      --orange:#f59e0b;
      --red:#ef4444;
      --slate:#334155;
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e5e7eb;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#0f172a}
    .app{display:flex;min-height:100vh}
    .sidebar{width:240px;background:#fff;border-right:1px solid var(--border)}
    .sidebar-header{padding:16px 18px;font-weight:800;border-bottom:1px solid var(--border)}
    .nav-link{display:block;padding:12px 16px;color:var(--slate);text-decoration:none;cursor:pointer}
    .nav-link:hover{background:#f1f5f9}
    .nav-link.active{background:#eef6ff;border-left:3px solid var(--blue);color:#1d4ed8}
    main{flex:1;padding:24px}
    .hidden{display:none}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:18px}
    .filters{display:flex;gap:16px;row-gap:10px;flex-wrap:wrap;align-items:flex-end}
    .filters label{display:block;font-size:12px;font-weight:700;margin-bottom:6px;color:#475569}
    .filters select{min-width:150px;padding:6px;border-radius:8px;border:1px solid #cbd5e1}
    .filters select[multiple]{height:110px}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--border);border-radius:8px;cursor:pointer;background:#fff}
    .btn-primary{border-color:transparent;background:var(--blue);color:#fff}
    .btn-outline{background:#fff}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .kpi{background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:12px}
    .kpi .label{font-size:12px;color:#64748b}
    .kpi .value{font-size:20px;font-weight:800;margin-top:6px}
    .charts{display:grid;grid-template-columns:1fr;gap:16px}
    .chart-card h3{margin:0 0 8px;font-size:14px;color:#334155}
    .table-wrap{max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
    th{background:#f8fafc;position:sticky;top:0;z-index:1}
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="sidebar-header"><i class="fas fa-chart-line"></i> Financial Reports</div>
    <a class="nav-link active" data-page="overview">Overview</a>
    <a class="nav-link" data-page="lending-volume">Lending Volume</a>
    <a class="nav-link" data-page="arrears">Arrears</a>
    <a class="nav-link" data-page="liquidations">Liquidations</a>
    <a class="nav-link" data-page="complaints">Complaints</a>
    <a class="nav-link" data-page="financial-crime">Financial Crime</a>
  </aside>

  <main>
    <!-- Overview -->
    <section id="overview-page" class="page">
      <div class="panel"><h2>Welcome</h2><p>Data auto-loaded from <code>/shared-data/</code> CSVs in this repo.</p></div>
    </section>

    <!-- Lending -->
    <section id="lending-volume-page" class="page hidden">
      <div class="panel">
        <h2>Lending Volume</h2>
        <div id="lending-volume-filters" class="filters"></div>
        <button class="btn btn-outline" id="lending-volume-reset"><i class="fas fa-eraser"></i> Reset Filters</button>
      </div>
      <div id="lending-volume-content"></div>
    </section>

    <!-- Arrears -->
    <section id="arrears-page" class="page hidden">
      <div class="panel">
        <h2>Arrears</h2>
        <div id="arrears-filters" class="filters"></div>
        <button class="btn btn-outline" id="arrears-reset"><i class="fas fa-eraser"></i> Reset Filters</button>
      </div>
      <div id="arrears-content"></div>
    </section>

    <!-- Liquidations -->
    <section id="liquidations-page" class="page hidden">
      <div class="panel">
        <h2>Liquidations</h2>
        <div id="liquidations-filters" class="filters"></div>
        <button class="btn btn-outline" id="liquidations-reset"><i class="fas fa-eraser"></i> Reset Filters</button>
      </div>
      <div id="liquidations-content"></div>
    </section>

    <!-- Keep generic for these two (unchanged for now) -->
    <section id="complaints-page" class="page hidden">
      <div class="panel"><h2>Complaints</h2><div id="complaints-content"></div></div>
    </section>
    <section id="financial-crime-page" class="page hidden">
      <div class="panel"><h2>Financial Crime</h2><div id="financial-crime-content"></div></div>
    </section>
  </main>
</div>

<script>
// ---------------------- GLOBAL STATE ----------------------
const reportData = {
  'lending-volume': [],
  'arrears': [],
  'liquidations': [],
  'complaints': [],
  'financial-crime': []
};

const reportConfigs = {
  'lending-volume': { dateField: 'FundedDate' },
  'arrears': { dateField: 'StageDate' },
  'liquidations': { dateField: 'StageDate' },
  'complaints': { dateField: 'ReceivedDate' },
  'financial-crime': { dateField: 'Date Reported' }
};

// ---------------------- HELPERS ----------------------
function toDateSafe(v){
  if(!v) return null;
  const d = new Date(v);
  return isNaN(d) ? null : d;
}
function sumField(rows, field){
  return rows.reduce((a,r)=>a+(parseFloat(r[field])||0),0);
}
function avgField(rows, field){
  const vals = rows.map(r=>parseFloat(r[field])||0).filter(v=>v>0);
  return vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : 0;
}
function fmtMoney(n){
  return 'Â£' + (Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
}
function fmtPct(n){
  return (Number(n)||0).toFixed(1) + '%';
}

// ---------------------- FILTERING ----------------------
function getFiltered(report, dateField){
  const rows = reportData[report] || [];

  // Grab selections
  const ySel = Array.from(document.getElementById(report+'-year')?.selectedOptions||[])
                    .map(o=>o.value).filter(v=>v!=='');
  const mSel = Array.from(document.getElementById(report+'-month')?.selectedOptions||[])
                    .map(o=>o.value).filter(v=>v!=='');
  const tSel = Array.from(document.getElementById(report+'-tier')?.selectedOptions||[])
                    .map(o=>o.value).filter(v=>v!=='');
  const sSel = Array.from(document.getElementById(report+'-stage')?.selectedOptions||[])
                    .map(o=>o.value).filter(v=>v!=='');
  
  return rows.filter(r=>{
    const d = toDateSafe(r[dateField]);
    if (ySel.length && (!d || !ySel.includes(String(d.getFullYear())))) return false;
    if (mSel.length && (!d || !mSel.includes(String(d.getMonth()+1)))) return false;
    if (tSel.length && !tSel.includes(String(r['TierName']||''))) return false;
    if (sSel.length && !sSel.includes(String(r['Stage']||''))) return false;
    return true;
  });
}

// ---------------------- RENDERERS ----------------------
function renderLendingReport(){
  const data = getFiltered('lending-volume','FundedDate');
  const issued = sumField(data,'IssuedAmount');
  const avgIssued = avgField(data,'IssuedAmount');
  const fundedCount = data.filter(r=>r.Stage && r.Stage.toLowerCase().includes('fund')).length;
  const activeCustomers = new Set(data.map(r=>r.CustomerID)).size;

  document.getElementById('lending-volume-content').innerHTML = `
    <div class="kpi-grid">
      <div class="kpi"><div class="label">Total Issued Amount</div><div class="value">${fmtMoney(issued)}</div></div>
      <div class="kpi"><div class="label">Average Issued</div><div class="value">${fmtMoney(avgIssued)}</div></div>
      <div class="kpi"><div class="label">Funded Applications</div><div class="value">${fundedCount}</div></div>
      <div class="kpi"><div class="label">Active Customers</div><div class="value">${activeCustomers}</div></div>
    </div>
    <canvas id="lendingChart"></canvas>
  `;

  // Chart: Issued by Year
  const byYear = {};
  data.forEach(r=>{
    const d = toDateSafe(r.FundedDate);
    const y = d ? d.getFullYear() : 'Unknown';
    byYear[y] = (byYear[y]||0) + (parseFloat(r.IssuedAmount)||0);
  });
  new Chart(document.getElementById('lendingChart'),{
    type:'bar',
    data:{labels:Object.keys(byYear),datasets:[{label:'Issued',data:Object.values(byYear),backgroundColor:'#3b82f6'}]},
    options:{responsive:true,scales:{y:{beginAtZero:true}}}
  });
}

function renderArrearsReport(){
  const data = getFiltered('arrears','StageDate');
  const issued = sumField(data,'IssuedAmount');
  const due = sumField(data,'TotalDue');

  document.getElementById('arrears-content').innerHTML = `
    <div class="kpi-grid">
      <div class="kpi"><div class="label">Total Issued Amount</div><div class="value">${fmtMoney(issued)}</div></div>
      <div class="kpi"><div class="label">Total Due</div><div class="value">${fmtMoney(due)}</div></div>
    </div>
    <canvas id="arrearsChart"></canvas>
  `;

  // Chart: Due by Stage
  const byStage = {};
  data.forEach(r=>{
    const st = r.Stage||'Unknown';
    byStage[st] = (byStage[st]||0) + (parseFloat(r.TotalDue)||0);
  });
  new Chart(document.getElementById('arrearsChart'),{
    type:'bar',
    data:{labels:Object.keys(byStage),datasets:[{label:'Total Due',data:Object.values(byStage),backgroundColor:'#f59e0b'}]},
    options:{responsive:true,scales:{y:{beginAtZero:true}}}
  });
}

function renderLiquidationsReport(){
  const data = getFiltered('liquidations','StageDate');
  const issued = sumField(data,'IssuedAmount');
  const paid = sumField(data,'Payment');
  const rate = issued>0 ? (paid/issued*100) : 0;

  document.getElementById('liquidations-content').innerHTML = `
    <div class="kpi-grid">
      <div class="kpi"><div class="label">Total Issued Amount</div><div class="value">${fmtMoney(issued)}</div></div>
      <div class="kpi"><div class="label">Total Paid</div><div class="value">${fmtMoney(paid)}</div></div>
      <div class="kpi"><div class="label">Liquidation %</div><div class="value">${fmtPct(rate)}</div></div>
    </div>
    <canvas id="liqChart"></canvas>
  `;

  // Chart: Issued vs Paid by Tier
  const byTier = {};
  data.forEach(r=>{
    const t = r.TierName||'Unknown';
    if(!byTier[t]) byTier[t] = {issued:0,paid:0};
    byTier[t].issued += (parseFloat(r.IssuedAmount)||0);
    byTier[t].paid += (parseFloat(r.Payment)||0);
  });
  new Chart(document.getElementById('liqChart'),{
    type:'bar',
    data:{
      labels:Object.keys(byTier),
      datasets:[
        {label:'Issued',data:Object.values(byTier).map(v=>v.issued),backgroundColor:'#3b82f6'},
        {label:'Paid',data:Object.values(byTier).map(v=>v.paid),backgroundColor:'#10b981'}
      ]
    },
    options:{responsive:true,scales:{y:{beginAtZero:true}}}
  });
}

// ---------------------- LOADER ----------------------
async function loadSharedData(){
  const files = {
    'lending-volume':'shared-data/lending_volume.csv',
    'arrears':'shared-data/lending_volume.csv',
    'liquidations':'shared-data/lending_volume.csv',
    'complaints':'shared-data/complaints.csv',
    'financial-crime':'shared-data/financial_crime.csv'
  };
  for(const [key,path] of Object.entries(files)){
    try{
      const text = await (await fetch(path)).text();
      reportData[key] = parseCSV(text);
      console.log(`Loaded ${reportData[key].length} rows for ${key}`);
    }catch(e){console.error('Error loading',key,e);}
  }
}

// ---------------------- CSV PARSER ----------------------
function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim());
  if(!lines.length) return [];
  const headers = lines[0].split(',').map(h=>h.trim());
  return lines.slice(1).map(line=>{
    const cols = line.split(',');
    const rec = {};
    headers.forEach((h,i)=>rec[h] = cols[i]);
    return rec;
  });
}

// ---------------------- INIT ----------------------
document.addEventListener('DOMContentLoaded',async()=>{
  await loadSharedData();
  renderLendingReport();
  renderArrearsReport();
  renderLiquidationsReport();
});
</script>
