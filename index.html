<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Financial Reports Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin:0; background:#f8fafc; color:#0f172a; }
    .app-container { display:flex; min-height:100vh; }
    .sidebar { width:260px; background:#fff; border-right:1px solid #e2e8f0; }
    .sidebar-header { padding:18px 20px; font-weight:700; border-bottom:1px solid #e2e8f0; }
    .nav-link { cursor:pointer; padding:12px 18px; display:flex; gap:10px; align-items:center; color:#334155; }
    .nav-link:hover { background:#f1f5f9; }
    .nav-link.active { background:#eef6ff; border-left:3px solid #3b82f6; color:#1d4ed8; }
    .main-content { flex:1; padding:24px; }
    .page-header { margin-bottom:16px; }
    .page-title { font-size:24px; font-weight:800; }
    .hidden { display:none; }
    .panel { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:18px; margin-bottom:18px; }
    .filters { display:flex; gap:16px; row-gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .filters label { font-size:12px; font-weight:700; color:#475569; display:block; margin-bottom:6px; }
    .filters select { min-width:140px; padding:8px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; }
    .filters select[multiple]{ min-width:200px; height:112px; }
    .kpi-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:14px; }
    .kpi { background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:14px 16px; }
    .kpi .label { font-size:12px; color:#64748b; }
    .kpi .value { font-size:22px; font-weight:800; margin-top:6px; }
    .charts-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap:16px; }
    .chart-card h3 { margin:0 0 8px 0; font-size:14px; color:#334155; }
    .data-table table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 12px; border-bottom:1px solid #e5e7eb; text-align:left; white-space:nowrap; }
    th { background:#f8fafc; position:sticky; top:0; z-index:1; }
    .table-wrap { max-height:420px; overflow:auto; border:1px solid #e5e7eb; border-radius:12px; }
    .small { color:#64748b; font-size:12px; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header"><i class="fas fa-chart-line"></i> Financial Reports</div>
      <nav>
        <div class="nav-link active" onclick="showPage(event,'overview')"><i class="fas fa-home"></i> Overview</div>
        <div class="nav-link" onclick="showPage(event,'data-management')"><i class="fas fa-upload"></i> Data Management</div>
        <div class="nav-link" onclick="showPage(event,'lending-volume')"><i class="fas fa-coins"></i> Lending Volume</div>
        <div class="nav-link" onclick="showPage(event,'arrears')"><i class="fas fa-exclamation-triangle"></i> Arrears</div>
        <div class="nav-link" onclick="showPage(event,'liquidations')"><i class="fas fa-sync"></i> Liquidations</div>
        <div class="nav-link" onclick="showPage(event,'complaints')"><i class="fas fa-clipboard-list"></i> Complaints</div>
        <div class="nav-link" onclick="showPage(event,'financial-crime')"><i class="fas fa-user-shield"></i> Financial Crime</div>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="main-content">
      <!-- Overview -->
      <section id="overview-page">
        <div class="page-header"><div class="page-title">Welcome</div></div>
        <div class="panel small">Upload CSVs under <strong>Data Management</strong>, then explore reports.</div>
      </section>

      <!-- Data Management -->
      <section id="data-management-page" class="hidden">
        <div class="page-header"><div class="page-title">Data Management</div></div>
        <div class="panel"><h3>Lending Volume</h3><input type="file" accept=".csv,.tsv" onchange="uploadFile(this,'lending-volume')"/><div id="lending-volume-status" class="small"></div></div>
        <div class="panel"><h3>Arrears</h3><input type="file" accept=".csv,.tsv" onchange="uploadFile(this,'arrears')"/><div id="arrears-status" class="small"></div></div>
        <div class="panel"><h3>Liquidations</h3><input type="file" accept=".csv,.tsv" onchange="uploadFile(this,'liquidations')"/><div id="liquidations-status" class="small"></div></div>
        <div class="panel"><h3>Complaints</h3><input type="file" accept=".csv,.tsv" onchange="uploadFile(this,'complaints')"/><div id="complaints-status" class="small"></div></div>
        <div class="panel"><h3>Financial Crime</h3><input type="file" accept=".csv,.tsv" onchange="uploadFile(this,'financial-crime')"/><div id="financial-crime-status" class="small"></div></div>
      </section>

      <!-- Report pages -->
      <section id="lending-volume-page" class="hidden"><div class="page-header"><div class="page-title">Lending Volume</div></div><div id="lending-volume-filters" class="panel"></div><div id="lending-volume-content"></div></section>
      <section id="arrears-page" class="hidden"><div class="page-header"><div class="page-title">Arrears</div></div><div id="arrears-filters" class="panel"></div><div id="arrears-content"></div></section>
      <section id="liquidations-page" class="hidden"><div class="page-header"><div class="page-title">Liquidations</div></div><div id="liquidations-filters" class="panel"></div><div id="liquidations-content"></div></section>
      <section id="complaints-page" class="hidden"><div class="page-header"><div class="page-title">Complaints</div></div><div id="complaints-filters" class="panel"></div><div id="complaints-content"></div></section>
      <section id="financial-crime-page" class="hidden"><div class="page-header"><div class="page-title">Financial Crime</div></div><div id="financial-crime-filters" class="panel"></div><div id="financial-crime-content"></div></section>
    </main>
  </div>

  <script>
    const reportData = { 'lending-volume':[], 'arrears':[], 'liquidations':[], 'complaints':[], 'financial-crime':[] };
    const charts = {};

    // ---------- Helpers ----------
    function cleanNumber(x){
      if(x===null||x===undefined) return NaN;
      let s=String(x).trim();
      if(!s) return NaN;
      let neg=false;
      if(/^\(.*\)$/.test(s)){ neg=true; s=s.slice(1,-1); }
      s=s.replace(/[£,\s]/g,'');
      const n=parseFloat(s);
      return isNaN(n)?NaN:(neg?-n:n);
    }
    function numericList(data,f){ const arr=[]; for(const r of data){const v=r[f];if(v!==undefined&&String(v).trim()!==''){const n=cleanNumber(v);if(!isNaN(n))arr.push(n);} } return arr;}
    function sumField(data,f){return numericList(data,f).reduce((a,b)=>a+b,0);}
    function avgField(data,f){const arr=numericList(data,f);return arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:0;}
    function fmtMoney(n){return (Number.isFinite(n)?n:0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});}
    function escapeHtml(str){return String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));}
    function toDate(v){if(!v) return NaN;const d=new Date(v);if(!isNaN(d))return d;const m=String(v).match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);return m?new Date(+m[3],+m[2]-1,+m[1]):new Date(v);}

    // ---------- CSV Parser ----------
    function parseCSV(text){
      const lines=String(text||'').replace(/^\uFEFF/,'').split(/\r?\n/).filter(l=>l.trim());
      if(!lines.length) return [];
      const delim=detectDelimiter(lines[0]);
      const headers=splitRow(lines[0],delim);
      const rows=[];
      for(let i=1;i<lines.length;i++){
        const parts=splitRow(lines[i],delim);
        if(!parts.length) continue;
        const rec={}; headers.forEach((h,j)=>rec[h]=(parts[j]||'').replace(/\uFFFD/g,'').trim());
        rows.push(rec);
      }
      return rows;
    }
    function detectDelimiter(line){let c=(d)=>{let cnt=0,inQ=false;for(let i=0;i<line.length;i++){if(line[i]==='"')inQ=!inQ;else if(!inQ&&line[i]===d)cnt++;}return cnt;};return c('\t')>c(',')?'\t':',';}
    function splitRow(row,delim){const out=[];let cur='',inQ=false;for(let i=0;i<row.length;i++){const ch=row[i];if(ch==='"'){if(inQ&&row[i+1]==='"'){cur+='"';i++;}else inQ=!inQ;}else if(ch===delim&&!inQ){out.push(cur);cur='';}else cur+=ch;}out.push(cur);return out;}

    // ---------- Configs ----------
    const reportConfigs={
      'lending-volume':{dateField:'FundedDate',amountField:'IssuedAmount',filterFields:['TierName','Stage'],
        kpis:d=>{const t=d.length;const tot=sumField(d,'IssuedAmount');const avg=avgField(d,'IssuedAmount');return[
          {label:'Total Loans',value:t.toLocaleString()},{label:'Total Issued',value:'£'+fmtMoney(tot)},{label:'Average Issued',value:'£'+fmtMoney(avg)}];},defaultGroup:'Stage'},
      'arrears':{dateField:'StageDate',amountField:'TotalDue',filterFields:['TierName','Stage'],
        kpis:d=>{const t=d.length;const tot=sumField(d,'TotalDue');const avg=avgField(d,'TotalDue');return[
          {label:'Total Accounts',value:t.toLocaleString()},{label:'Total Due',value:'£'+fmtMoney(tot)},{label:'Average Due',value:'£'+fmtMoney(avg)}];},defaultGroup:'Stage'},
      'liquidations':{dateField:'StageDate',amountField:'TotalDue',filterFields:['TierName','Stage'],
        kpis:d=>{const t=d.length;const tot=sumField(d,'TotalDue');const avg=avgField(d,'TotalDue');return[
          {label:'Total Liquidations',value:t.toLocaleString()},{label:'Total Due @ Liquidation',value:'£'+fmtMoney(tot)},{label:'Average Due',value:'£'+fmtMoney(avg)}];},defaultGroup:'Stage'},
      'complaints':{dateField:'ReceivedDate',filterFields:['Category','Decision'],
        kpis:d=>{const tot=sumField(d,'Count')||d.length;const avg=avgField(d,'DaysToResolve');const open=d.filter(r=>!r['ResolvedDate']).length;return[
          {label:'Total Complaints',value:tot.toLocaleString()},{label:'Avg Days to Resolve',value:avg.toFixed(1)},{label:'Open (no ResolvedDate)',value:open.toLocaleString()}];},defaultGroup:'Category'},
      'financial-crime':{dateField:'Date Reported',amountField:'Principal',filterFields:['Loan Source','AppStatus','Decision'],
        kpis:d=>{const t=d.length;const tot=sumField(d,'Principal');const avg=avgField(d,'Principal');return[
          {label:'Total Cases',value:t.toLocaleString()},{label:'Total Principal',value:'£'+fmtMoney(tot)},{label:'Average Principal',value:'£'+fmtMoney(avg)}];},defaultGroup:'Decision'}
    };

    // ---------- Page Nav ----------
    function showPage(e,id){document.querySelectorAll('[id$="-page"]').forEach(p=>p.classList.add('hidden'));document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));document.getElementById(id+'-page').classList.remove('hidden');if(e)e.currentTarget.classList.add('active');if(reportConfigs[id]){buildFiltersUI(id);renderReport(id);}}
    function uploadFile(inp,type){const f=inp.files?.[0];if(!f)return;const r=new FileReader();r.onload=e=>{reportData[type]=parseCSV(e.target.result);document.getElementById(type+'-status').textContent=`Loaded ${reportData[type].length} records`;buildFiltersUI(type);renderReport(type);};r.readAsText(f);}

    // ---------- Filters / Render ----------
    function buildFiltersUI(type){/* unchanged from earlier full code, left out here for brevity */}
    function renderReport(type){/* unchanged except uses new kpis & helpers */}

  </script>
</body>
</html>
