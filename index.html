<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Financial Reports Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin:0; background:#f8fafc; color:#0f172a; }
    .app-container { display:flex; min-height:100vh; }
    .sidebar { width:260px; background:#fff; border-right:1px solid #e2e8f0; }
    .sidebar-header { padding:18px 20px; font-weight:700; border-bottom:1px solid #e2e8f0; }
    .nav-link { cursor:pointer; padding:12px 18px; display:flex; gap:10px; align-items:center; color:#334155; }
    .nav-link:hover { background:#f1f5f9; }
    .nav-link.active { background:#eef6ff; border-left:3px solid #3b82f6; color:#1d4ed8; }
    .main-content { flex:1; padding:24px; }
    .page-header { margin-bottom:16px; }
    .page-title { font-size:24px; font-weight:800; }
    .hidden { display:none; }
    .panel { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:18px; margin-bottom:18px; }
    .filters { display:flex; gap:16px; row-gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .filters label { font-size:12px; font-weight:700; color:#475569; display:block; margin-bottom:6px; }
    .filters select { min-width:140px; padding:8px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; }
    .filters select[multiple]{ min-width:200px; height:112px; }
    .kpi-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:14px; }
    .kpi { background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:14px 16px; }
    .kpi .label { font-size:12px; color:#64748b; }
    .kpi .value { font-size:22px; font-weight:800; margin-top:6px; }
    .charts-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap:16px; }
    .chart-card h3 { margin:0 0 8px 0; font-size:14px; color:#334155; }
    .data-table table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 12px; border-bottom:1px solid #e5e7eb; text-align:left; white-space:nowrap; }
    th { background:#f8fafc; position:sticky; top:0; z-index:1; }
    .table-wrap { max-height:420px; overflow:auto; border:1px solid #e5e7eb; border-radius:12px; }
    .small { color:#64748b; font-size:12px; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header"><i class="fas fa-chart-line"></i> Financial Reports</div>
      <nav>
        <div class="nav-link active" onclick="showPage(event,'overview')"><i class="fas fa-home"></i> Overview</div>
        <div class="nav-link" onclick="showPage(event,'lending-volume')"><i class="fas fa-coins"></i> Lending Volume</div>
        <div class="nav-link" onclick="showPage(event,'arrears')"><i class="fas fa-exclamation-triangle"></i> Arrears</div>
        <div class="nav-link" onclick="showPage(event,'liquidations')"><i class="fas fa-sync"></i> Liquidations</div>
        <div class="nav-link" onclick="showPage(event,'complaints')"><i class="fas fa-clipboard-list"></i> Complaints</div>
        <div class="nav-link" onclick="showPage(event,'financial-crime')"><i class="fas fa-user-shield"></i> Financial Crime</div>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="main-content">
      <section id="overview-page">
        <div class="page-header"><div class="page-title">Welcome</div></div>
        <div class="panel">
          <h3>Data Summary</h3>
          <div id="overview-summary" class="kpi-grid"></div>
        </div>
      </section>

      <section id="lending-volume-page" class="hidden"><div class="page-header"><div class="page-title">Lending Volume</div></div><div id="lending-volume-filters" class="panel"></div><div id="lending-volume-content"></div></section>
      <section id="arrears-page" class="hidden"><div class="page-header"><div class="page-title">Arrears</div></div><div id="arrears-filters" class="panel"></div><div id="arrears-content"></div></section>
      <section id="liquidations-page" class="hidden"><div class="page-header"><div class="page-title">Liquidations</div></div><div id="liquidations-filters" class="panel"></div><div id="liquidations-content"></div></section>
      <section id="complaints-page" class="hidden"><div class="page-header"><div class="page-title">Complaints</div></div><div id="complaints-filters" class="panel"></div><div id="complaints-content"></div></section>
      <section id="financial-crime-page" class="hidden"><div class="page-header"><div class="page-title">Financial Crime</div></div><div id="financial-crime-filters" class="panel"></div><div id="financial-crime-content"></div></section>
    </main>
  </div>

    <script>
/* ========== GLOBALS ========== */
const reportData = { 'lending-volume':[], 'arrears':[], 'liquidations':[], 'complaints':[], 'financial-crime':[] };
const lastUpdated = {};
const charts = {};

/* ========== HELPERS ========== */
function cleanNumber(x){ if(x===null||x===undefined) return NaN; let s=String(x).trim(); if(!s) return NaN; let neg=false; if(/^\(.*\)$/.test(s)){ neg=true; s=s.slice(1,-1); } s=s.replace(/[£,\s]/g,''); const n=parseFloat(s); return isNaN(n)?NaN:(neg?-n:n);}
function numericList(data,f){const arr=[];for(const r of data){const v=r[f];if(v!==undefined&&String(v).trim()!==''){const n=cleanNumber(v);if(!isNaN(n))arr.push(n);}}return arr;}
function sumField(data,f){return numericList(data,f).reduce((a,b)=>a+b,0);}
function avgField(data,f){const arr=numericList(data,f);return arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:0;}
function fmtMoney(n){return (Number.isFinite(n)?n:0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});}
function escapeHtml(str){return String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));}
function toDate(v){if(!v) return NaN;const d=new Date(v);if(!isNaN(d))return d;return NaN;}
function uniqueSorted(arr){return Array.from(new Set(arr)).sort((a,b)=>(''+a).localeCompare((''+b),undefined,{numeric:true}));}

/* ========== CSV PARSER ========== */
function parseCSV(text){
  const lines=String(text||'').replace(/^\uFEFF/,'').split(/\r?\n/).filter(l=>l.trim());
  if(!lines.length) return [];
  const delim=lines[0].includes('\t')?'\t':',';
  const headers=lines[0].split(delim);
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const parts=lines[i].split(delim);
    const rec={};
    headers.forEach((h,j)=>rec[h]=(parts[j]||'').trim());
    rows.push(rec);
  }
  return rows;
}

/* ========== CONFIGS ========== */
const reportConfigs={
  'lending-volume':{dateField:'FundedDate',filterFields:['TierName','Stage'],
    kpis:d=>[{label:'Total Loans',value:d.length},{label:'Total Issued',value:'£'+fmtMoney(sumField(d,'IssuedAmount'))},{label:'Average Issued',value:'£'+fmtMoney(avgField(d,'IssuedAmount'))}],defaultGroup:'Stage'},
  'arrears':{dateField:'StageDate',filterFields:['TierName','Stage'],
    kpis:d=>[{label:'Total Issued Amount',value:'£'+fmtMoney(sumField(d,'IssuedAmount'))},{label:'Total Due',value:'£'+fmtMoney(sumField(d,'TotalDue'))}],defaultGroup:'Stage'},
  'liquidations':{dateField:'StageDate',filterFields:['TierName','Stage'],
    kpis:d=>{const issued=sumField(d,'IssuedAmount');const paid=sumField(d,'Payment');return[{label:'Total Issued',value:'£'+fmtMoney(issued)},{label:'Total Paid',value:'£'+fmtMoney(paid)},{label:'Recovery %',value:(issued?(paid/issued*100).toFixed(1)+'%':'0%')}];},defaultGroup:'Stage'},
  'complaints':{dateField:'ReceivedDate',filterFields:['Category','Decision'],
    kpis:d=>[{label:'Total Complaints',value:d.length},{label:'Avg Days to Resolve',value:avgField(d,'DaysToResolve').toFixed(1)}],defaultGroup:'Category'},
  'financial-crime':{dateField:'Date Reported',filterFields:['Loan Source','AppStatus','Decision'],
    kpis:d=>[{label:'Total Cases',value:d.length},{label:'Total Principal',value:'£'+fmtMoney(sumField(d,'Principal'))}],defaultGroup:'Decision'}
};

/* ========== NAVIGATION ========== */
function showPage(e,id){
  document.querySelectorAll('[id$="-page"]').forEach(p=>p.classList.add('hidden'));
  document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
  document.getElementById(id+'-page').classList.remove('hidden');
  if(e) e.currentTarget.classList.add('active');
  if(reportConfigs[id]){ buildFiltersUI(id); renderReport(id); }
}

/* ========== FILTERS ========== */
function buildFiltersUI(type){
  const container=document.getElementById(`${type}-filters`);
  const cfg=reportConfigs[type];
  const data=reportData[type]||[];
  container.innerHTML='';
  if(!data.length) return;
  const wrap=document.createElement('div');wrap.className='filters';
  wrap.appendChild(selectBlock(`${type}-year`,'Year',uniqueSorted(data.map(r=>toDate(r[cfg.dateField])?.getFullYear()).filter(Boolean)),false,true,()=>updateReport(type)));
  const months=["01","02","03","04","05","06","07","08","09","10","11","12"];
  wrap.appendChild(selectBlock(`${type}-month`,'Month',months,false,true,()=>updateReport(type)));
  (cfg.filterFields||[]).forEach(f=>{
    const vals=uniqueSorted(data.map(r=>r[f]||'Unknown'));
    wrap.appendChild(selectBlock(`${type}-filter-${f}`,f,vals,true,true,()=>updateReport(type)));
  });
  container.appendChild(wrap);
}
function selectBlock(id,label,values,multiple=false,includeAll=false,onChange=()=>{}){
  const block=document.createElement('div');
  const lab=document.createElement('label');lab.textContent=label;
  const sel=document.createElement('select');sel.id=id;if(multiple) sel.multiple=true;if(includeAll) sel.appendChild(new Option('All',''));
  values.forEach(v=>sel.appendChild(new Option(v,v)));
  sel.onchange=onChange;block.appendChild(lab);block.appendChild(sel);return block;
}

/* ========== RENDER ========== */
function updateReport(type){ renderReport(type); }
function renderReport(type){
  const content=document.getElementById(`${type}-content`);
  const cfg=reportConfigs[type];const dataRaw=reportData[type]||[];
  if(!dataRaw.length){content.innerHTML="<div class='panel small'>No data</div>";return;}
  const data=applyFilters(type,dataRaw,cfg);if(!data.length){content.innerHTML="<div class='panel small'>No data for filters</div>";return;}
  const kpiHtml="<div class='panel'><div class='kpi-grid'>"+cfg.kpis(data).map(k=>`<div class="kpi"><div class="label">${k.label}</div><div class="value">${k.value}</div></div>`).join('')+"</div></div>";
  const {labels,values}=groupData(data,cfg.defaultGroup,cfg);
  const chartHtml=`<div class="charts-grid"><div class="panel chart-card"><h3>Bar</h3><canvas id="${type}-bar"></canvas></div><div class="panel chart-card"><h3>Line</h3><canvas id="${type}-line"></canvas></div><div class="panel chart-card"><h3>Pie</h3><canvas id="${type}-pie"></canvas></div></div>`;
  content.innerHTML=kpiHtml+chartHtml;
  drawCharts(type,{barId:`${type}-bar`,lineId:`${type}-line`,pieId:`${type}-pie`},labels,values);
}

/* ========== FILTER + GROUP ========== */
function applyFilters(type,data,cfg){
  const y=document.getElementById(`${type}-year`)?.value||'';const m=document.getElementById(`${type}-month`)?.value||'';
  return data.filter(r=>{
    const d=toDate(r[cfg.dateField]);if(y&&(!d||d.getFullYear()!=y)) return false;if(m&&(!d||String(d.getMonth()+1).padStart(2,'0')!==m)) return false;return true;
  });
}
function groupData(data,field,cfg){
  const map={};data.forEach(r=>{const k=r[field]||'Unknown';map[k]=(map[k]||0)+1;});
  const labels=Object.keys(map);return {labels,values:labels.map(l=>map[l])};
}

/* ========== CHARTS ========== */
function drawCharts(type,ids,labels,values){
  charts[type]?.bar?.destroy();charts[type]?.line?.destroy();charts[type]?.pie?.destroy();
  const d={labels,datasets:[{label:'Count',data:values}]};
  charts[type]={};
  charts[type].bar=new Chart(document.getElementById(ids.barId),{type:'bar',data:d});
  charts[type].line=new Chart(document.getElementById(ids.lineId),{type:'line',data:d});
  charts[type].pie=new Chart(document.getElementById(ids.pieId),{type:'pie',data:d});
}

/* ========== OVERVIEW ========== */
function updateOverviewSummary(){
  const c=document.getElementById("overview-summary");c.innerHTML="";
  Object.keys(reportConfigs).forEach(t=>{
    const d=reportData[t]||[];const k=d.length?reportConfigs[t].kpis(d)[0]:{label:"No data",value:"—"};
    c.innerHTML+=`<div class="kpi"><div class="label">${t}</div><div class="value">${k.value}</div></div>`;
  });
}

/* ========== LOAD DATA ========== */
async function loadSharedData(){
  const files={
    'lending-volume':'shared-data/lending_volume.csv',
    'arrears':'shared-data/lending_volume.csv',
    'liquidations':'shared-data/lending_volume.csv',
    'complaints':'shared-data/complaints.csv',
    'financial-crime':'shared-data/financial_crime.csv'
  };
  for(const [k,p] of Object.entries(files)){
    try{const res=await fetch(p);const text=await res.text();reportData[k]=parseCSV(text);lastUpdated[k]=new Date().toLocaleString();console.log("Loaded",reportData[k].length,"for",k);}catch(e){console.error("Error loading",p,e);}
  }
  Object.keys(reportConfigs).forEach(t=>{buildFiltersUI(t);renderReport(t);});
  updateOverviewSummary();showPage(null,'overview');
}
document.addEventListener('DOMContentLoaded',loadSharedData);
  </script>
</body>
</html>
