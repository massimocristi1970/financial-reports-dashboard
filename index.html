<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Financial Reports Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin:0; background:#f8fafc; color:#0f172a; }
    .app-container { display:flex; min-height:100vh; }
    .sidebar { width:260px; background:#fff; border-right:1px solid #e2e8f0; }
    .sidebar-header { padding:18px 20px; font-weight:700; border-bottom:1px solid #e2e8f0; }
    .nav-link { cursor:pointer; padding:12px 18px; display:flex; gap:10px; align-items:center; color:#334155; text-decoration:none; }
    .nav-link:hover { background:#f1f5f9; }
    .nav-link.active { background:#eef6ff; border-left:3px solid #3b82f6; color:#1d4ed8; }
    .main-content { flex:1; padding:24px; }
    .page-header { margin-bottom:16px; }
    .page-title { font-size:24px; font-weight:800; }
    .hidden { display:none; }
    .panel { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:18px; margin-bottom:18px; }
    .kpi-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:14px; }
    .kpi-card { background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:14px 16px; }
    .kpi-title { font-size:12px; color:#64748b; }
    .kpi-value { font-size:22px; font-weight:800; margin-top:6px; }
    .chart-card { background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:20px; margin-bottom:20px; }
    .chart-title { font-weight:600; margin-bottom:10px; }
    .progress-bar { background:#e5e7eb; border-radius:6px; height:10px; overflow:hidden; }
    .progress-fill { background:#3b82f6; height:100%; }
    .data-table table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 12px; border-bottom:1px solid #e5e7eb; text-align:left; }
    th { background:#f8fafc; position:sticky; top:0; }
    .currency { font-weight:600; color:#16a34a; }
    .status { padding:8px 12px; border-radius:8px; margin-top:10px; font-size:14px; }
    .status-success { background:#dcfce7; color:#166534; }
    .status-error { background:#fee2e2; color:#991b1b; }
    .status-info { background:#dbeafe; color:#1e3a8a; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header"><i class="fas fa-chart-line"></i> Financial Reports</div>
      <nav>
        <a href="#" class="nav-link active" data-page="overview"><i class="fas fa-home"></i> Overview</a>
        <a href="#" class="nav-link" data-page="data-management"><i class="fas fa-upload"></i> Data Management</a>
        <a href="#" class="nav-link" data-page="lending-volume"><i class="fas fa-coins"></i> Lending Volume</a>
        <a href="#" class="nav-link" data-page="arrears"><i class="fas fa-exclamation-triangle"></i> Arrears</a>
        <a href="#" class="nav-link" data-page="liquidations"><i class="fas fa-sync"></i> Liquidations</a>
        <a href="#" class="nav-link" data-page="complaints"><i class="fas fa-clipboard-list"></i> Complaints</a>
        <a href="#" class="nav-link" data-page="financial-crime"><i class="fas fa-user-shield"></i> Financial Crime</a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main-content">
      <section id="overview-page" class="page">
        <div class="page-header"><div class="page-title">Welcome</div></div>
        <div class="panel small">Upload CSVs under <strong>Data Management</strong>, then explore reports.</div>
        <div id="overview-summary" class="kpi-grid"></div>
      </section>

      <section id="data-management-page" class="page hidden">
        <div class="page-header"><div class="page-title">Data Management</div></div>
        <div class="panel"><h3>Lending Volume</h3><input type="file" accept=".csv" onchange="FinancialDashboard.handleFileUpload(event,'lending-volume')"/><div id="lending-volume-status" class="small"></div></div>
        <div class="panel"><h3>Arrears</h3><input type="file" accept=".csv" onchange="FinancialDashboard.handleFileUpload(event,'arrears')"/><div id="arrears-status" class="small"></div></div>
        <div class="panel"><h3>Liquidations</h3><input type="file" accept=".csv" onchange="FinancialDashboard.handleFileUpload(event,'liquidations')"/><div id="liquidations-status" class="small"></div></div>
        <div class="panel"><h3>Complaints</h3><input type="file" accept=".csv" onchange="FinancialDashboard.handleFileUpload(event,'complaints')"/><div id="complaints-status" class="small"></div></div>
        <div class="panel"><h3>Financial Crime</h3><input type="file" accept=".csv" onchange="FinancialDashboard.handleFileUpload(event,'financial-crime')"/><div id="financial-crime-status" class="small"></div></div>
      </section>

      <!-- Report Pages -->
      <section id="lending-volume-page" class="page hidden"><div class="page-header"><div class="page-title">Lending Volume</div></div><div class="report-content" data-report="lending-volume"></div></section>
      <section id="arrears-page" class="page hidden"><div class="page-header"><div class="page-title">Arrears</div></div><div class="report-content" data-report="arrears"></div></section>
      <section id="liquidations-page" class="page hidden"><div class="page-header"><div class="page-title">Liquidations</div></div><div class="report-content" data-report="liquidations"></div></section>
      <section id="complaints-page" class="page hidden"><div class="page-header"><div class="page-title">Complaints</div></div><div class="report-content" data-report="complaints"></div></section>
      <section id="financial-crime-page" class="page hidden"><div class="page-header"><div class="page-title">Financial Crime</div></div><div class="report-content" data-report="financial-crime"></div></section>
    </main>
  </div>

  <script>
  const FinancialDashboard = {
    data: {
      'lending-volume': [],
      'arrears': [],
      'liquidations': [],
      'complaints': [],
      'financial-crime': []
    },

    init() {
      this.setupNavigation();
    },

    setupNavigation() {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const page = e.currentTarget.dataset.page;
          this.showPage(page);
          document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
          e.currentTarget.classList.add('active');
        });
      });
    },

    async handleFileUpload(event, reportType) {
      const file = event.target.files[0];
      if (!file) return;
      const statusElement = document.getElementById(`${reportType}-status`);
      try {
        statusElement.innerHTML = '<div class="status status-info">Processing CSV file...</div>';
        const csvText = await file.text();
        const data = this.parseCSVText(csvText);
        this.data[reportType] = data;
        statusElement.innerHTML = `<div class="status status-success">Loaded ${data.length} records</div>`;
        this.renderReport(reportType);
        this.updateOverviewSummary();
      } catch (err) {
        statusElement.innerHTML = `<div class="status status-error">Error: ${err.message}</div>`;
      }
    },

    parseCSVText(csvText) {
      const lines = String(csvText||'').replace(/^\uFEFF/,'').split(/\r?\n/).filter(l => l.trim());
      if (!lines.length) throw new Error("Empty CSV file");

      const detectDelimiter = (line) => {
        const counts = {',':0,';':0,'\t':0};
        let inQ=false;
        for (let i=0;i<line.length;i++){
          const c=line[i];
          if(c==='"') inQ=!inQ;
          else if(!inQ && counts.hasOwnProperty(c)) counts[c]++;
        }
        return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0] || ',';
      };

      const delim = detectDelimiter(lines[0]);
      const parseLine = (line) => {
        const out=[],len=line.length;
        let cur="",inQ=false;
        for(let i=0;i<len;i++){
          const ch=line[i];
          if(ch==='"'){
            if(inQ && line[i+1]==='"'){cur+='"';i++;}
            else inQ=!inQ;
          } else if(ch===delim && !inQ){out.push(cur);cur="";}
          else cur+=ch;
        }
        out.push(cur);
        return out;
      };

      const headers=parseLine(lines[0]).map(h=>h.trim().toLowerCase().replace(/\s+/g,'_'));
      const data=[];
      for(let i=1;i<lines.length;i++){
        const values=parseLine(lines[i]);
        const rec={};
        headers.forEach((h,idx)=>{
          let v=values[idx]||'';
          if(typeof v==='string' && (v.includes('£')||v.includes('€')||v.includes('$'))){
            v=v.replace(/[£€$,]/g,'');
            if(!isNaN(parseFloat(v))) v=parseFloat(v);
          } else if(!isNaN(parseFloat(v)) && isFinite(v)){
            v=parseFloat(v);
          }
          rec[h]=v;
        });
        if(Object.values(rec).some(val=>val!=='')) data.push(rec);
      }
      return data;
    },

    showPage(pageId) {
      document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
      const page=document.getElementById(`${pageId}-page`);
      if(page) page.classList.remove('hidden');
      if(pageId!=='overview'&&pageId!=='data-management'){this.renderReport(pageId);}
    },

    renderReport(reportType) {
      const content=document.querySelector(`[data-report="${reportType}"]`);
      const data=this.data[reportType];
      if(!content) return;
      if(!data.length){
        content.innerHTML='<div class="chart-card">No data uploaded.</div>';
        return;
      }
      const headers=Object.keys(data[0]);
      const tableRows=data.slice(0,50).map(r=>
        `<tr>${headers.map(h=>`<td>${r[h]}</td>`).join('')}</tr>`).join('');
      content.innerHTML=`
        <div class="data-table">
          <div class="table-header"><h3>Data Records (${data.length} total)</h3></div>
          <div class="table-wrap">
            <table>
              <thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
              <tbody>${tableRows}</tbody>
            </table>
          </div>
        </div>`;
    },

    updateOverviewSummary() {
      const container=document.getElementById("overview-summary");
      container.innerHTML="";
      Object.entries(this.data).forEach(([type,data])=>{
        const label=type.replace('-', ' ').replace(/\b\w/g,l=>l.toUpperCase());
        container.innerHTML+=`
          <div class="kpi-card">
            <div class="kpi-title">${label}</div>
            <div class="kpi-value">${data.length} records</div>
          </div>`;
      });
    }
  };

  document.addEventListener('DOMContentLoaded',()=>FinancialDashboard.init());
  </script>
</body>
</html>
