<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Reports Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; }
    .app-container { display:flex; }
    .sidebar { width:250px; background:#fff; border-right:1px solid #ddd; min-height:100vh; }
    .main-content { flex:1; padding:20px; }
    .hidden { display:none; }
    .nav-link { cursor:pointer; padding:12px; display:flex; align-items:center; }
    .nav-link.active { background:#eef6ff; border-left:3px solid #3b82f6; color:#3b82f6; }
    .page-header { margin-bottom:20px; }
    .page-title { font-size:24px; font-weight:bold; }
    .data-table { background:#fff; border:1px solid #ddd; border-radius:8px; margin-top:20px; }
    table { width:100%; border-collapse:collapse; }
    th,td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
    tr:hover { background:#f9f9f9; }
    .chart-card, .kpi-grid { background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px; margin-bottom:20px; }
    .kpi-grid { display:flex; gap:20px; }
    .kpi-card { flex:1; text-align:center; background:#f9fafb; border-radius:8px; padding:15px; }
    .kpi-title { font-size:14px; color:#666; }
    .kpi-value { font-size:22px; font-weight:bold; margin-top:5px; }
  </style>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="sidebar-header" style="padding:20px; font-weight:bold;">Financial Reports</div>
      <nav>
        <div class="nav-link active" onclick="showPage(event,'overview')"><i class="fas fa-home"></i> Overview</div>
        <div class="nav-link" onclick="showPage(event,'data-management')"><i class="fas fa-upload"></i> Data Management</div>
        <div class="nav-link" onclick="showPage(event,'lending-volume')"><i class="fas fa-coins"></i> Lending Volume</div>
      </nav>
    </aside>

    <main class="main-content">
      <div id="overview-page">
        <div class="page-header"><h1 class="page-title">Welcome</h1></div>
        <p>Upload data and view reports using the sidebar.</p>
      </div>

      <div id="data-management-page" class="hidden">
        <div class="page-header"><h1 class="page-title">Data Management</h1></div>
        <div>
          <h3>Lending Volume</h3>
          <input type="file" accept=".csv" id="lending-file"
                 onchange="uploadFile(this,'lending-volume')">
          <div id="lending-volume-status"></div>
        </div>
      </div>

      <div id="lending-volume-page" class="hidden">
        <div class="page-header"><h1 class="page-title">Lending Volume Analysis</h1></div>
        <div id="lending-volume-content"></div>
      </div>
    </main>
  </div>

  <script>
    let reportData = { 'lending-volume': [] };
    let charts = {};

    function showPage(event, pageId) {
      document.querySelectorAll('[id$="-page"]').forEach(p => p.classList.add('hidden'));
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.getElementById(pageId + '-page').classList.remove('hidden');
      event.currentTarget.classList.add('active');
      if (pageId === 'lending-volume') renderReport('lending-volume');
    }

    function uploadFile(fileInput, reportType) {
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const data = parseCSV(e.target.result);
        reportData[reportType] = data;
        document.getElementById(reportType + '-status').innerText =
          `Loaded ${data.length} records`;
      };
      reader.readAsText(file);
    }

    function parseCSV(csvText) {
      const lines = csvText.split('\n').filter(l => l.trim());
      if (!lines.length) return [];
      const headers = lines[0].split(/,|\t/).map(h => h.trim()); // handles CSV or TSV
      return lines.slice(1).map(line => {
        const values = line.split(/,|\t/).map(v => v.trim());
        const rec = {};
        headers.forEach((h,i)=> rec[h]=values[i]);
        return rec;
      });
    }

    function renderReport(reportType) {
      const content = document.getElementById(reportType + '-content');
      const data = reportData[reportType];
      if (!data.length) {
        content.innerHTML = `<div class="chart-card"><p>No data available</p></div>`;
        return;
      }

      // --- KPIs ---
      let total = data.length;
      let totalIssued = data.reduce((s,r)=> s + (parseFloat(r['IssuedAmount']) || 0), 0);
      let avgIssued = (totalIssued / total).toFixed(2);

      const summaryHTML = `
        <div class="kpi-grid">
          <div class="kpi-card"><div class="kpi-title">Total Loans</div><div class="kpi-value">${total}</div></div>
          <div class="kpi-card"><div class="kpi-title">Total Issued</div><div class="kpi-value">£${totalIssued.toLocaleString()}</div></div>
          <div class="kpi-card"><div class="kpi-title">Average Issued</div><div class="kpi-value">£${avgIssued}</div></div>
        </div>
      `;

      // --- Chart ---
      const chartId = reportType + '-chart';
      const chartHTML = `
        <div class="chart-card"><h3>Lending by Stage</h3>
          <canvas id="${chartId}" height="120"></canvas>
        </div>
      `;

      // --- Table ---
      const headers = Object.keys(data[0]);
      let tableHTML = `<div class="data-table"><table><thead><tr>`;
      headers.forEach(h => tableHTML += `<th>${h}</th>`);
      tableHTML += `</tr></thead><tbody>`;
      data.slice(0,100).forEach(row=>{
        tableHTML += `<tr>`+headers.map(h=>`<td>${row[h]||''}</td>`).join('')+`</tr>`;
      });
      tableHTML += `</tbody></table></div>`;

      content.innerHTML = summaryHTML + chartHTML + tableHTML;

      // --- Draw Chart ---
      setTimeout(()=>{
        const ctx = document.getElementById(chartId).getContext('2d');
        if (charts[reportType]) charts[reportType].destroy();
        const labels = [...new Set(data.map(r => r['Stage'] || 'Unknown'))];
        const values = labels.map(l => data.filter(r => (r['Stage'] || 'Unknown') === l).length);

        charts[reportType] = new Chart(ctx,{
          type:'bar',
          data:{ labels, datasets:[{label:'Loans', data:values,
            backgroundColor:'rgba(59,130,246,0.6)',
            borderColor:'rgba(59,130,246,1)', borderWidth:1 }]},
          options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
        });
      },50);
    }
  </script>
</body>
</html>
