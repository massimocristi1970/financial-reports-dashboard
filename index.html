<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Reports Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; }
    .app-container { display:flex; }
    .sidebar { width:250px; background:#fff; border-right:1px solid #ddd; min-height:100vh; }
    .main-content { flex:1; padding:20px; }
    .hidden { display:none; }
    .nav-link { cursor:pointer; padding:12px; display:flex; align-items:center; }
    .nav-link.active { background:#eef6ff; border-left:3px solid #3b82f6; color:#3b82f6; }
    .page-header { margin-bottom:20px; }
    .page-title { font-size:24px; font-weight:bold; }
    .filters { display:flex; flex-wrap:wrap; gap:15px; margin-bottom:20px; }
    .filters label { margin-right:5px; font-weight:bold; }
    .data-table { background:#fff; border:1px solid #ddd; border-radius:8px; margin-top:20px; }
    table { width:100%; border-collapse:collapse; }
    th,td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
    tr:hover { background:#f9f9f9; }
    .chart-card, .kpi-grid { background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px; margin-bottom:20px; }
    .kpi-grid { display:flex; gap:20px; flex-wrap:wrap; }
    .kpi-card { flex:1; text-align:center; background:#f9fafb; border-radius:8px; padding:15px; min-width:150px; }
    .kpi-title { font-size:14px; color:#666; }
    .kpi-value { font-size:22px; font-weight:bold; margin-top:5px; }
  </style>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="sidebar-header" style="padding:20px; font-weight:bold;">Financial Reports</div>
      <nav>
        <div class="nav-link active" onclick="showPage(event,'overview')"><i class="fas fa-home"></i> Overview</div>
        <div class="nav-link" onclick="showPage(event,'data-management')"><i class="fas fa-upload"></i> Data Management</div>
        <div class="nav-link" onclick="showPage(event,'lending-volume')"><i class="fas fa-coins"></i> Lending Volume</div>
      </nav>
    </aside>

    <main class="main-content">
      <div id="overview-page">
        <div class="page-header"><h1 class="page-title">Welcome</h1></div>
        <p>Upload data and view reports using the sidebar.</p>
      </div>

      <div id="data-management-page" class="hidden">
        <div class="page-header"><h1 class="page-title">Data Management</h1></div>
        <div>
          <h3>Lending Volume</h3>
          <input type="file" accept=".csv,.tsv" id="lending-file"
                 onchange="uploadFile(this,'lending-volume')">
          <div id="lending-volume-status"></div>
        </div>
      </div>

      <div id="lending-volume-page" class="hidden">
        <div class="page-header"><h1 class="page-title">Lending Volume Analysis</h1></div>

        <!-- Filters -->
        <div class="filters">
          <label for="yearFilter">Year:</label>
          <select id="yearFilter" onchange="updateReport('lending-volume')"></select>

          <label for="monthFilter">Month:</label>
          <select id="monthFilter" onchange="updateReport('lending-volume')"></select>

          <label for="tierFilter">Tier:</label>
          <select id="tierFilter" multiple size="4" onchange="updateReport('lending-volume')"></select>

          <label for="stageFilter">Stage:</label>
          <select id="stageFilter" multiple size="4" onchange="updateReport('lending-volume')"></select>
        </div>

        <div id="lending-volume-content"></div>
      </div>
    </main>
  </div>

  <script>
    let reportData = { 'lending-volume': [] };
    let charts = {};

    const reportConfigs = {
      'lending-volume': {
        dateField: 'FundedDate',
        amountField: 'IssuedAmount'
      }
    };

    function showPage(event, pageId) {
      document.querySelectorAll('[id$="-page"]').forEach(p => p.classList.add('hidden'));
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.getElementById(pageId + '-page').classList.remove('hidden');
      event.currentTarget.classList.add('active');
      if (pageId === 'lending-volume') {
        populateFilters('lending-volume');
        renderReport('lending-volume');
      }
    }

    function uploadFile(fileInput, reportType) {
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const data = parseCSV(e.target.result);
        reportData[reportType] = data;
        document.getElementById(reportType + '-status').innerText =
          `Loaded ${data.length} records`;
      };
      reader.readAsText(file);
    }

    function parseCSV(csvText) {
      const lines = csvText.split('\n').filter(l => l.trim());
      if (!lines.length) return [];
      const headers = lines[0].split(/,|\t/).map(h => h.trim());
      return lines.slice(1).map(line => {
        const values = line.split(/,|\t/).map(v => v.replace(/\uFFFD/g,'').trim()); // strip “?”
        const rec = {};
        headers.forEach((h,i)=> rec[h]=values[i]);
        return rec;
      });
    }

    function populateFilters(reportType) {
      const data = reportData[reportType];
      if (!data.length) return;

      const dateField = reportConfigs[reportType].dateField;

      // Years
      const years = [...new Set(data.map(r => {
        const d = new Date(r[dateField]);
        return isNaN(d) ? null : d.getFullYear();
      }).filter(Boolean))].sort();

      const yearSel = document.getElementById("yearFilter");
      yearSel.innerHTML = '<option value="">All</option>' + years.map(y=>`<option value="${y}">${y}</option>`).join('');

      // Months
      const monthSel = document.getElementById("monthFilter");
      monthSel.innerHTML = '<option value="">All</option>' +
        Array.from({length:12},(_,i)=>`<option value="${String(i+1).padStart(2,'0')}">${i+1}</option>`).join('');

      // Tiers
      const tiers = [...new Set(data.map(r => r['TierName'] || 'Unknown'))].sort();
      const tierSel = document.getElementById("tierFilter");
      tierSel.innerHTML = '<option value="">All</option>' + tiers.map(t=>`<option value="${t}">${t}</option>`).join('');

      // Stages
      const stages = [...new Set(data.map(r => r['Stage'] || 'Unknown'))].sort();
      const stageSel = document.getElementById("stageFilter");
      stageSel.innerHTML = '<option value="">All</option>' + stages.map(s=>`<option value="${s}">${s}</option>`).join('');
    }

    function applyFilters(reportType) {
      const year = document.getElementById("yearFilter").value;
      const month = document.getElementById("monthFilter").value;
      const tiers = Array.from(document.getElementById("tierFilter").selectedOptions).map(o => o.value).filter(v => v !== "");
      const stages = Array.from(document.getElementById("stageFilter").selectedOptions).map(o => o.value).filter(v => v !== "");

      const data = reportData[reportType];
      const dateField = reportConfigs[reportType].dateField;

      return data.filter(r => {
        // Date filter
        const rawDate = r[dateField];
        if (rawDate) {
          const dt = new Date(rawDate);
          if (!isNaN(dt)) {
            if (year && dt.getFullYear().toString() !== year) return false;
            if (month && (dt.getMonth()+1).toString().padStart(2,'0') !== month) return false;
          }
        }
        // Tier filter
        if (tiers.length && !tiers.includes(r['TierName'] || 'Unknown')) return false;
        // Stage filter
        if (stages.length && !stages.includes(r['Stage'] || 'Unknown')) return false;

        return true;
      });
    }

    function updateReport(reportType) {
      renderReport(reportType);
    }

    function renderReport(reportType) {
      const content = document.getElementById(reportType + '-content');
      let data = applyFilters(reportType);

      if (!data.length) {
        content.innerHTML = `<div class="chart-card"><p>No data for selected filters</p></div>`;
        return;
      }

      const config = reportConfigs[reportType];

      // --- KPIs ---
      let total = data.length;
      let totalIssued = data.reduce((s,r)=> {
        let val = (r[config.amountField] || '').toString().replace(/[^0-9.-]/g,'');
        return s + (parseFloat(val) || 0);
      }, 0);
      let avgIssued = (totalIssued / total).toFixed(2);

      const summaryHTML = `
        <div class="kpi-grid">
          <div class="kpi-card"><div class="kpi-title">Total Loans</div><div class="kpi-value">${total}</div></div>
          <div class="kpi-card"><div class="kpi-title">Total Issued</div><div class="kpi-value">£${totalIssued.toLocaleString()}</div></div>
          <div class="kpi-card"><div class="kpi-title">Average Issued</div><div class="kpi-value">£${avgIssued}</div></div>
        </div>
      `;

      // --- Chart ---
      const chartId = reportType + '-chart';
      const chartHTML = `
        <div class="chart-card"><h3>Loans by Stage</h3>
          <canvas id="${chartId}" height="120"></canvas>
        </div>
      `;

      // --- Table ---
      const headers = Object.keys(data[0]);
      let tableHTML = `<div class="data-table"><table><thead><tr>`;
      headers.forEach(h => tableHTML += `<th>${h}</th>`);
      tableHTML += `</tr></thead><tbody>`;
      data.slice(0,100).forEach(row=>{
        tableHTML += `<tr>`+headers.map(h=>`<td>${row[h]||''}</td>`).join('')+`</tr>`;
      });
      tableHTML += `</tbody></table></div>`;

      // --- Render ---
      content.innerHTML = summaryHTML + chartHTML + tableHTML;

      // --- Draw Chart ---
      setTimeout(()=>{
        const ctx = document.getElementById(chartId).getContext('2d');
        if (charts[reportType]) charts[reportType].destroy();

        const labels = [...new Set(data.map(r => r['Stage'] || 'Unknown'))];
        const values = labels.map(l => data.filter(r => (r['Stage'] || 'Unknown') === l).length);

        charts[reportType] = new Chart(ctx,{
          type:'bar',
          data:{ labels, datasets:[{label:'Loans', data:values,
            backgroundColor:'rgba(59,130,246,0.6)',
            borderColor:'rgba(59,130,246,1)', borderWidth:1 }]},
          options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
        });
      },50);
    }
  </script>
</body>
</html>
