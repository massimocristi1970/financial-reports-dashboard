<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Financial Reports Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --blue:#3b82f6;
      --green:#10b981;
      --orange:#f59e0b;
      --red:#ef4444;
      --slate:#334155;
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e5e7eb;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#0f172a}
    .app{display:flex;min-height:100vh}
    .sidebar{width:240px;background:#fff;border-right:1px solid var(--border)}
    .sidebar-header{padding:16px 18px;font-weight:800;border-bottom:1px solid var(--border)}
    .nav-link{display:block;padding:12px 16px;color:var(--slate);text-decoration:none;cursor:pointer}
    .nav-link:hover{background:#f1f5f9}
    .nav-link.active{background:#eef6ff;border-left:3px solid var(--blue);color:#1d4ed8}
    main{flex:1;padding:24px}
    .hidden{display:none}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:18px}
    .filters{display:flex;gap:16px;row-gap:10px;flex-wrap:wrap;align-items:flex-end}
    .filters label{display:block;font-size:12px;font-weight:700;margin-bottom:6px;color:#475569}
    .filters select{min-width:150px;padding:6px;border-radius:8px;border:1px solid #cbd5e1}
    .filters select[multiple]{height:110px}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--border);border-radius:8px;cursor:pointer;background:#fff}
    .btn-primary{border-color:transparent;background:var(--blue);color:#fff}
    .btn-outline{background:#fff}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .kpi{background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:12px}
    .kpi .label{font-size:12px;color:#64748b}
    .kpi .value{font-size:20px;font-weight:800;margin-top:6px}
    .charts{display:grid;grid-template-columns:1fr;gap:16px}
    .chart-card h3{margin:0 0 8px;font-size:14px;color:#334155}
    .table-wrap{max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
    th{background:#f8fafc;position:sticky;top:0;z-index:1}
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="sidebar-header"><i class="fas fa-chart-line"></i> Financial Reports</div>
    <a class="nav-link active" data-page="overview">Overview</a>
    <a class="nav-link" data-page="lending-volume">Lending Volume</a>
    <a class="nav-link" data-page="arrears">Arrears</a>
    <a class="nav-link" data-page="liquidations">Liquidations</a>
    <a class="nav-link" data-page="complaints">Complaints</a>
    <a class="nav-link" data-page="financial-crime">Financial Crime</a>
  </aside>

  <main>
    <!-- Overview -->
    <section id="overview-page" class="page">
      <div class="panel"><h2>Welcome</h2><p>Data auto-loaded from <code>/shared-data/</code> CSVs in this repo.</p></div>
    </section>

    <!-- Lending -->
    <section id="lending-volume-page" class="page hidden">
      <div class="panel">
        <h2>Lending Volume</h2>
        <div id="lending-volume-filters" class="filters"></div>
        <button class="btn btn-outline" id="lending-volume-reset"><i class="fas fa-eraser"></i> Reset Filters</button>
      </div>
      <div id="lending-volume-content"></div>
    </section>

    <!-- Arrears -->
    <section id="arrears-page" class="page hidden">
      <div class="panel">
        <h2>Arrears</h2>
        <div id="arrears-filters" class="filters"></div>
        <button class="btn btn-outline" id="arrears-reset"><i class="fas fa-eraser"></i> Reset Filters</button>
      </div>
      <div id="arrears-content"></div>
    </section>

    <!-- Liquidations -->
    <section id="liquidations-page" class="page hidden">
      <div class="panel">
        <h2>Liquidations</h2>
        <div id="liquidations-filters" class="filters"></div>
        <button class="btn btn-outline" id="liquidations-reset"><i class="fas fa-eraser"></i> Reset Filters</button>
      </div>
      <div id="liquidations-content"></div>
    </section>

    <!-- Keep generic for these two (unchanged for now) -->
    <section id="complaints-page" class="page hidden">
      <div class="panel"><h2>Complaints</h2><div id="complaints-content"></div></div>
    </section>
    <section id="financial-crime-page" class="page hidden">
      <div class="panel"><h2>Financial Crime</h2><div id="financial-crime-content"></div></div>
    </section>
  </main>
</div>

<script>
/* -------------------- Data sources -------------------- */
const dataSources = {
  "lending-volume":"shared-data/lending_volume.csv",
  "arrears":"shared-data/lending_volume.csv",
  "liquidations":"shared-data/lending_volume.csv",
  "complaints":"shared-data/complaints.csv",
  "financial-crime":"shared-data/financial_crime.csv"
};

const dateField = {
  "lending-volume":"fundeddate",
  "arrears":"stagedate",
  "liquidations":"stagedate",
  "complaints":"receiveddate",
  "financial-crime":"datereported"
};

const reportData = {};   // raw normalised data per report
const charts = {};       // chart instances per canvas id

/* -------------------- Helpers -------------------- */
function normalizeHeader(h){
  return String(h||'')
    .trim()
    .toLowerCase()
    .replace(/\s+/g,'');   // strip spaces entirely
}

function cleanNumber(v) {
  if (v == null) return 0;

  let s = String(v)
    .trim()
    .replace(/\u00A0/g, '')   // non-breaking space
    .replace(/Â/g, '');       // stray 'Â' from bad encoding

  if (!s) return 0;

  let neg = false;
  if (/^\(.*\)$/.test(s)) {
    neg = true;
    s = s.slice(1, -1).trim();
  }

  if (/^\d{1,3}(\.\d{3})+,\d{2}$/.test(s)) {
    s = s.replace(/\./g, '').replace(',', '.');
  } else {
    s = s.replace(/[£€$,]/g, '');
  }

  const n = parseFloat(s);
  return Number.isFinite(n) ? (neg ? -n : n) : 0;
}

/* --- Debug Date Parser --- */
function toDateSafe(v){
  if(!v) return null;
  if (v instanceof Date) return isNaN(v) ? null : v;

  let s = String(v).trim();

  // Excel serial number
  if (/^\d{4,6}$/.test(s)) {
    const n = parseInt(s, 10);
    if (n > 20000 && n < 60000) {
      const d = new Date(1899, 11, 30 + n);
      return d;
    }
  }

  // ISO-like YYYY-MM-DD
  if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
    return new Date(s.split(" ")[0]);
  }

  // UK-style D/M/Y or D-M-Y
  let m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if (m) return new Date(+m[3], +m[2]-1, +m[1]);

  const d = new Date(s);
  return isNaN(d) ? null : d;
}

function fmtMoney(n){ return "£"+(cleanNumber(n)).toLocaleString(undefined,{maximumFractionDigits:2}); }
function sum(rows, key){ return rows.reduce((a,r)=>a + cleanNumber(r[key]), 0); }
function avg(rows, key){ const vals=rows.map(r=>cleanNumber(r[key])).filter(v=>v>0); return vals.length? vals.reduce((a,b)=>a+b,0)/vals.length : 0; }

/* -------------------- Filters UI -------------------- */
function getFiltered(report, dfKey) {
  const rows = reportData[report] || [];

  const ySel = Array.from(document.getElementById(report+'-year')?.selectedOptions||[]).map(o=>o.value);
  const mSel = Array.from(document.getElementById(report+'-month')?.selectedOptions||[]).map(o=>o.value);
  const tSel = Array.from(document.getElementById(report+'-tiername')?.selectedOptions||[]).map(o=>o.value);
  const sSel = Array.from(document.getElementById(report+'-stage')?.selectedOptions||[]).map(o=>o.value);

  return rows.filter(r=>{
    const raw = r[dfKey];
    const d = toDateSafe(raw);

    if (!d && raw) {
      console.warn(`Unparsed date for ${report}:`, raw);
    }

    if (ySel.length && (!d || !ySel.includes(String(d.getFullYear())))) return false;
    if (mSel.length && (!d || !mSel.includes(String((d.getMonth()+1)).padStart(2,'0')))) return false;
    if (tSel.length && !tSel.includes(r.tiername||'')) return false;
    if (sSel.length && !sSel.includes(r.stage||'')) return false;

    return true;
  });
}

/* -------------------- Lending Report (with debug) -------------------- */
function renderLendingReport(){
  const report='lending-volume';
  const target=document.getElementById(`${report}-content`);
  const rows = getFiltered(report, dateField[report]);
  if(!rows.length){ target.innerHTML = `<div class="panel">No data for current filters.</div>`; return; }

  // Debug: log sample values
  console.log("Sample FundedDate values:", rows.slice(0,10).map(r=>r[dateField[report]]));
  console.log("Sample IssuedAmount raw:", rows.slice(0,10).map(r=>r.issuedamount));
  console.log("Sample IssuedAmount cleaned:", rows.slice(0,10).map(r=>cleanNumber(r.issuedamount)));

  const totalIssued = sum(rows,'issuedamount');
  const avgIssued = avg(rows,'issuedamount');
  const fundedCount = rows.reduce((a,r)=> a + (cleanNumber(r.count) || 1), 0);

  console.log("Lending totals:", {totalIssued, avgIssued, fundedCount, filteredRows: rows.length});

  const kpiHTML = `<div class="panel"><div class="kpis">
    <div class="kpi"><div class="label">Total Issued</div><div class="value">${fmtMoney(totalIssued)}</div></div>
    <div class="kpi"><div class="label">Average Issued</div><div class="value">${fmtMoney(avgIssued)}</div></div>
    <div class="kpi"><div class="label">Funded Count</div><div class="value">${fundedCount.toLocaleString()}</div></div>
  </div></div>`;

  target.innerHTML = kpiHTML + `<div class="panel">${renderTable(rows)}</div>`;
}

/* -------------------- Tables -------------------- */
function renderTable(rows, maxRows=100){
  if(!rows.length) return '';
  const headers = Object.keys(rows[0]);
  const head = `<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
  const body = `<tbody>${rows.slice(0,maxRows).map(r=>`<tr>${headers.map(h=>`<td>${r[h]??''}</td>`).join('')}</tr>`).join('')}</tbody>`;
  return `<div class="table-wrap"><table>${head}${body}</table></div>`;
}

/* -------------------- Load all data -------------------- */
async function loadAll(){
  for(const [rep,url] of Object.entries(dataSources)){
    try{
      const res = await fetch(url);
      const txt = await res.text();
      reportData[rep] = parseCSV(txt);
      console.log(`Loaded ${reportData[rep].length} rows for ${rep}`);
    }catch(err){
      console.error('Load error', rep, err);
      reportData[rep] = [];
    }
  }
}

document.addEventListener('DOMContentLoaded', async ()=>{
  await loadAll();
  renderLendingReport(); // just test lending for now
});
</script>
